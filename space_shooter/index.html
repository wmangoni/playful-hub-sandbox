<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KM6SHZXP');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Shooter Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #game-container {
            position: relative;
            width: 600px;
            height: 400px;
            border: 2px solid #333;
            background-color: #050510;
            overflow: hidden;
        }
        #player {
            position: absolute;
            width: 40px;
            height: 40px;
            bottom: 20px;
            left: 280px;
            transition: opacity 0.15s ease-in-out;
        }
        #player polygon {
            fill: #3498db;
        }
        #player rect {
            animation: thrust 0.1s infinite alternate;
        }
        @keyframes thrust {
            from { fill: #e74c3c; }
            to { fill: #ff7f50; }
        }
        .enemy {
            position: absolute;
            width: 30px;
            height: 30px;
            transition: transform 0.1s ease-out;
        }
        .enemy.hit {
            transform: scale(1.1);
            filter: brightness(1.5);
        }
        .bullet {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: #f1c40f;
            border-radius: 3px;
            box-shadow: 0 0 4px #f1c40f;
        }
        .special-bullet {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: #00ffff;
            box-shadow: 0 0 8px #00ffff, 0 0 4px #ffffff inset;
            border-radius: 3px;
        }
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background-color: white;
            border-radius: 50%;
            pointer-events: none;
        }
        .star-layer1 {
            width: 2px;
            height: 2px;
            opacity: 0.9;
        }
        .star-layer2 {
            width: 1.5px;
            height: 1.5px;
            opacity: 0.6;
        }
        .star-layer3 {
            width: 1px;
            height: 1px;
            opacity: 0.4;
        }
        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #player-hp-bar-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 100px;
            height: 15px;
            background-color: #555;
            border: 1px solid #888;
            border-radius: 3px;
        }
        #player-hp-bar-fill {
            height: 100%;
            width: 100%;
            background-color: #e74c3c;
            border-radius: 2px;
            transition: width 0.2s ease-out;
        }
        #special-charges {
            position: absolute;
            top: 40px;
            right: 10px;
            color: #00ffff;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #phase-display {
            position: absolute;
            top: 40px;
            left: 10px;
            color: #ff9900;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #special-active {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            color: #00ffff;
            font-size: 16px;
            display: none;
        }
        #special-bar {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
        }
        #special-bar-fill {
            height: 100%;
            width: 100%;
            background-color: #00ffff;
            border-radius: 5px;
            transition: width 0.1s;
        }
        #player.invulnerable {
            opacity: 0.5;
            animation: blink 0.15s linear infinite;
        }
        @keyframes blink {
            50% { opacity: 0.2; }
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .explosion {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: orange;
            border-radius: 50%;
            pointer-events: none;
            animation: explode 0.3s ease-out forwards;
            z-index: 5;
        }
        @keyframes explode {
            0% { transform: scale(0.1); opacity: 1; background-color: yellow; }
            50% { background-color: orange; }
            100% { transform: scale(1.5); opacity: 0; background-color: darkred; }
        }
        #game-container.shake {
            animation: screenShake 0.15s linear;
        }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px) rotate(-0.5deg); }
            50% { transform: translateX(3px) rotate(0.5deg); }
            75% { transform: translateX(-2px) rotate(-0.2deg); }
        }
        #boss {
            position: absolute;
            width: 100px;
            height: 100px;
            top: 30px;
            left: calc(50% - 50px);
            z-index: 3;
        }
        #boss svg {
            width: 100%;
            height: 100%;
        }
        #boss-hp-bar-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            background-color: #444;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 10;
            text-align: center;
        }
        #boss-hp-bar-fill {
            height: 100%;
            width: 100%;
            background-color: #e74c3c;
            border-radius: 4px;
            transition: width 0.3s ease-out;
        }
        #boss-name {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            line-height: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 1px black;
        }
        #high-score {
            margin-top: 10px;
            font-size: 18px;
            color: #f1c40f;
        }
        .enemy-bullet {
            position: absolute;
            width: 8px;
            height: 15px;
            background-color: #e74c3c;
            border-radius: 4px;
            box-shadow: 0 0 3px #e74c3c;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KM6SHZXP"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <div id="game-container">
        <div id="score">Score: 0</div>
        <div id="player-hp-bar-container">
            <div id="player-hp-bar-fill"></div>
        </div>
        <div id="phase-display">Fase: 1</div>
        <div id="special-charges">Tiro Especial: 3</div>
        <div id="special-active">TIRO TRIPLO ATIVO!</div>
        <div id="special-bar"><div id="special-bar-fill"></div></div>
        <div id="boss-hp-bar-container" style="display: none;">
            <div id="boss-hp-bar-fill"></div>
            <div id="boss-name">CHEFE</div>
        </div>
        <svg id="player" viewBox="0 0 100 100">
            <polygon points="50,0 100,100 50,70 0,100" fill="#3498db" />
            <rect x="45" y="70" width="10" height="20" fill="#e74c3c" />
        </svg>
        <div id="boss" style="display: none;">
            <svg viewBox="0 0 150 150">
                <rect x="10" y="10" width="130" height="100" fill="#8e44ad" rx="15" />
                <circle cx="75" cy="60" r="25" fill="#c0392b" />
                <rect x="30" y="110" width="20" height="30" fill="#bdc3c7" />
                <rect x="100" y="110" width="20" height="30" fill="#bdc3c7" />
            </svg>
        </div>
        <div id="game-over">
            <div>Game Over</div>
            <div id="final-score">Score: 0</div>
            <div id="high-score">High Score: 0</div>
            <button id="restart-button">Play Again</button>
        </div>
    </div>

    <!-- Efeitos Sonoros e MÃºsica -->
    <audio id="sfx-shoot" src="../assets/sounds/laser-shoot.mp3" preload="auto"></audio>
    <audio id="sfx-special-shoot" src="../assets/sounds/special-shoot.mp3" preload="auto"></audio>
    <audio id="sfx-enemy-hit" src="../assets/sounds/enemy_hit.mp3" preload="auto"></audio>
    <audio id="sfx-explosion" src="../assets/sounds/sfx-pop.mp3" preload="auto"></audio>
    <audio id="sfx-player-damage" src="../assets/sounds/player_damage.mp3" preload="auto"></audio>
    <audio id="sfx-game-over" src="../assets/sounds/game_over.mp3" preload="auto"></audio>
    <audio id="sfx-powerup" src="../assets/sounds/powerup.mp3" preload="auto"></audio>
    <audio id="bgm-game" src="../assets/sounds/trl-epica-dramatica-motivacional-arrepiante-202402121831.mp3" loop preload="auto"></audio>
    <audio id="bgm-game-over" src="../assets/sounds/game_over_bgm.mp3" preload="auto"></audio>

    <script>
        const gameContainer = document.getElementById('game-container');
        const player = document.getElementById('player');
        const scoreElement = document.getElementById('score');
        const playerHPBarFill = document.getElementById('player-hp-bar-fill');
        const phaseDisplay = document.getElementById('phase-display');
        const specialChargesElement = document.getElementById('special-charges');
        const specialActiveElement = document.getElementById('special-active');
        const specialBarFill = document.getElementById('special-bar-fill');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreElement = document.getElementById('final-score');
        const highScoreElement = document.getElementById('high-score');
        const restartButton = document.getElementById('restart-button');
        const bossElement = document.getElementById('boss');
        const bossHPContainer = document.getElementById('boss-hp-bar-container');
        const bossHPFill = document.getElementById('boss-hp-bar-fill');
        
        const containerWidth = gameContainer.offsetWidth;
        const containerHeight = gameContainer.offsetHeight;
        const playerWidth = 40;
        const playerHeight = 40;
        
        let playerX = containerWidth / 2 - playerWidth / 2;
        let playerY = containerHeight - playerHeight - 20;
        let bullets = [];
        let enemies = [];
        let enemyBullets = [];
        let stars = [];
        let score = 0;
        let highScore = 0;
        let playerMaxHP = 100;
        let playerCurrentHP = playerMaxHP;
        let isPlayerInvulnerable = false;
        let playerInvulnerableTimer = null;
        const playerInvulnerableDuration = 1500;
        let isGameOver = false;
        let gameLoopId;
        let currentPhase = 1;
        let phaseProgress = 0;
        const phaseGoals = [15, 1];
        let isBossActive = false;
        let bossData = {};
        let specialCharges = 3;
        let isSpecialActive = false;
        let specialTimer = null;
        let specialTimeLeft = 0;
        
        let isLeftPressed = false;
        let isRightPressed = false;
        let isFirePressed = false;
        let isSpecialPressed = false;
        let lastFireTime = 0;
        let lastEnemySpawnTime = 0;
        
        const sfxShoot = document.getElementById('sfx-shoot');
        const sfxSpecialShoot = document.getElementById('sfx-special-shoot');
        const sfxEnemyHit = document.getElementById('sfx-enemy-hit');
        const sfxExplosion = document.getElementById('sfx-explosion');
        const sfxPlayerDamage = document.getElementById('sfx-player-damage');
        const sfxGameOver = document.getElementById('sfx-game-over');
        const bgmGame = document.getElementById('bgm-game');
        const bgmGameOver = document.getElementById('bgm-game-over');
        
        function playSound(audioElement) {
            if (audioElement) {
                audioElement.currentTime = 0;
                audioElement.play().catch(error => {
                });
            }
        }
        
        function stopMusic() {
            if (bgmGame) bgmGame.pause();
            if (bgmGameOver) bgmGameOver.pause();
        }
        
        function createStars() {
            stars.forEach(star => {
                if(star.parentNode === gameContainer) gameContainer.removeChild(star);
            });
            stars = [];

            const starCounts = { layer1: 30, layer2: 40, layer3: 50 };
            const starSpeeds = { layer1: 0.8, layer2: 0.4, layer3: 0.2 };

            for (const layer in starCounts) {
                for (let i = 0; i < starCounts[layer]; i++) {
                    const star = document.createElement('div');
                    star.className = `star star-${layer}`;
                    star.style.left = Math.random() * containerWidth + 'px';
                    star.style.top = Math.random() * containerHeight + 'px';
                    star.speed = starSpeeds[layer] * (Math.random() * 0.5 + 0.75);
                    gameContainer.insertBefore(star, player);
                    stars.push(star);
                }
            }
        }
        
        function updatePlayer() {
            if (isLeftPressed && playerX > 0) {
                playerX -= 7;
            }
            if (isRightPressed && playerX < containerWidth - playerWidth) {
                playerX += 7;
            }
            player.style.left = playerX + 'px';
        }
        
        function createExplosion(x, y) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = (x - 25) + 'px';
            explosion.style.top = (y - 25) + 'px';
            gameContainer.appendChild(explosion);
            playSound(sfxExplosion);

            setTimeout(() => {
                if (explosion.parentNode === gameContainer) {
                    gameContainer.removeChild(explosion);
                }
            }, 300);
        }
        
        function fireBullet() {
            const currentTime = Date.now();
            if (currentTime - lastFireTime < 150) return;

            if (isSpecialActive) {
                const bullet1 = document.createElement('div');
                bullet1.className = 'special-bullet';
                bullet1.style.left = (playerX + playerWidth / 2 - 5) + 'px';
                bullet1.style.top = (playerY - 15) + 'px';
                bullet1.speedX = 0;
                bullet1.speedY = -10;
                gameContainer.appendChild(bullet1);
                bullets.push(bullet1);
                playSound(sfxSpecialShoot);
                
                const bullet2 = document.createElement('div');
                bullet2.className = 'special-bullet';
                bullet2.style.left = (playerX + playerWidth / 2 - 15) + 'px';
                bullet2.style.top = (playerY - 10) + 'px';
                bullet2.speedX = -2;
                bullet2.speedY = -9;
                gameContainer.appendChild(bullet2);
                bullets.push(bullet2);
                
                const bullet3 = document.createElement('div');
                bullet3.className = 'special-bullet';
                bullet3.style.left = (playerX + playerWidth / 2 + 5) + 'px';
                bullet3.style.top = (playerY - 10) + 'px';
                bullet3.speedX = 2;
                bullet3.speedY = -9;
                gameContainer.appendChild(bullet3);
                bullets.push(bullet3);
            } else {
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                bullet.style.left = (playerX + playerWidth / 2 - 5) + 'px';
                bullet.style.top = (playerY - 15) + 'px';
                bullet.speedX = 0;
                bullet.speedY = -10;
                gameContainer.appendChild(bullet);
                bullets.push(bullet);
                playSound(sfxShoot);
            }
            
            lastFireTime = currentTime;
        }
        
        function activateSpecial() {
            if (specialCharges > 0 && !isSpecialActive) {
                isSpecialActive = true;
                specialCharges--;
                specialChargesElement.textContent = `Tiro Especial: ${specialCharges}`;
                specialActiveElement.style.display = 'block';
                specialTimeLeft = 2000;
                
                if (specialTimer) {
                    clearInterval(specialTimer);
                }
                
                specialTimer = setInterval(() => {
                    specialTimeLeft -= 100;
                    const percentage = (specialTimeLeft / 2000) * 100;
                    specialBarFill.style.width = `${percentage}%`;
                    
                    if (specialTimeLeft <= 0) {
                        deactivateSpecial();
                    }
                }, 100);
            }
        }
        
        function deactivateSpecial() {
            isSpecialActive = false;
            specialActiveElement.style.display = 'none';
            specialBarFill.style.width = '0%';
            
            if (specialTimer) {
                clearInterval(specialTimer);
                specialTimer = null;
            }
        }
        
        function updateBullets() {
            for (let i = 0; i < bullets.length; i++) {
                const bullet = bullets[i];
                const x = parseFloat(bullet.style.left) + (bullet.speedX || 0);
                const y = parseFloat(bullet.style.top) + (bullet.speedY || -10);
                
                if (y < 0 || x < 0 || x > containerWidth) {
                    gameContainer.removeChild(bullet);
                    bullets.splice(i, 1);
                    i--;
                } else {
                    bullet.style.left = x + 'px';
                    bullet.style.top = y + 'px';
                }
            }
        }
        
        function createEnemy() {
            if (isBossActive) return;

            const now = Date.now();
            const timeSinceLastSpawn = now - lastEnemySpawnTime;

            const baseSpawnInterval = 1500 - (currentPhase * 100);
            const spawnInterval = Math.max(300, baseSpawnInterval);
            const maxEnemies = 6 + currentPhase * 2;

            if (timeSinceLastSpawn > spawnInterval && enemies.length < maxEnemies) {
                lastEnemySpawnTime = now;

                const enemy = document.createElement('div');
                enemy.className = 'enemy';

                let enemyType = 0;
                if (currentPhase >= 2) {
                    enemyType = Math.floor(Math.random() * 2);
                }

                enemy.innerHTML = `<svg viewBox="0 0 100 100">
                    ${enemyType === 0 ? '<circle cx="50" cy="50" r="40" fill="#e74c3c"/><circle cx="30" cy="40" r="10" fill="#000"/><circle cx="70" cy="40" r="10" fill="#000"/>' :
                      enemyType === 1 ? '<polygon points="10,50 50,10 90,50 50,90" fill="#9b59b6"/><circle cx="35" cy="45" r="8" fill="#000"/><circle cx="65" cy="45" r="8" fill="#000"/>' :
                      '<rect x="10" y="10" width="80" height="80" fill="#f39c12"/><rect x="25" y="30" width="15" height="15" fill="#000"/><rect x="60" y="30" width="15" height="15" fill="#000"/>'}
                </svg>`;

                const x = Math.random() * (containerWidth - 30);
                enemy.style.left = x + 'px';
                enemy.style.top = '-30px';

                const baseSpeed = 0.5 + (currentPhase * 0.15);
                enemy.speed = Math.random() * 1 + baseSpeed;

                if (currentPhase >= 2) {
                    enemy.movementType = Math.floor(Math.random() * 2);
                     if (enemy.movementType === 1) {
                         enemy.amplitude = Math.random() * 30 + 20;
                         enemy.frequency = Math.random() * 0.1 + 0.05;
                         enemy.movementOffset = Math.random() * Math.PI * 2;
                     }
                } else {
                    enemy.movementType = 0;
                }

                gameContainer.appendChild(enemy);
                enemies.push(enemy);
            }
        }
        
        function updateEnemies() {
            if (isBossActive) return;

            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                let x = parseFloat(enemy.style.left);
                let y = parseFloat(enemy.style.top) + enemy.speed;
                
                if (enemy.movementType === 1) {
                    enemy.movementOffset += enemy.frequency;
                    x += Math.sin(enemy.movementOffset) * 2;
                }
                
                if (x < 0) x = 0;
                if (x > containerWidth - 30) x = containerWidth - 30;

                if (y > containerHeight) {
                    if (enemy.parentNode === gameContainer) gameContainer.removeChild(enemy);
                    enemies.splice(i, 1);
                    if (currentPhase > 1) {
                        playerTakeDamage(10);
                    }
                } else {
                    enemy.style.left = x + 'px';
                    enemy.style.top = y + 'px';
                }
            }
        }
        
        function updateStars() {
            for (let i = 0; i < stars.length; i++) {
                const star = stars[i];
                let y = parseFloat(star.style.top) + star.speed;
                
                if (y > containerHeight) {
                    y = -5;
                    star.style.left = Math.random() * containerWidth + 'px';
                }
                
                star.style.top = y + 'px';
            }
        }
        
        function checkCollisions() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                if (!bullet) continue;
                const bulletRect = bullet.getBoundingClientRect();

                let hit = false;

                if (isBossActive) {
                    const bossRect = bossElement.getBoundingClientRect();
                    if (
                        bulletRect.left < bossRect.right &&
                        bulletRect.right > bossRect.left &&
                        bulletRect.top < bossRect.bottom &&
                        bulletRect.bottom > bossRect.top * 0.8
                    ) {
                        bossTakeDamage(bullet.classList.contains('special-bullet') ? 3 : 1);
                        hit = true;
                    }
                } else {
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        const enemy = enemies[j];
                        if (!enemy) continue;
                        const enemyRect = enemy.getBoundingClientRect();

                        if (
                            bulletRect.left < enemyRect.right &&
                            bulletRect.right > enemyRect.left &&
                            bulletRect.top < enemyRect.bottom &&
                            bulletRect.bottom > enemyRect.top
                        ) {
                            enemy.classList.add('hit');
                            setTimeout(() => enemy.classList.remove('hit'), 100);
                            playSound(sfxEnemyHit);

                            createExplosion(enemyRect.left + enemyRect.width / 2, enemyRect.top + enemyRect.height / 2);
                            if (enemy.parentNode === gameContainer) gameContainer.removeChild(enemy);
                            enemies.splice(j, 1);

                            score += 10 * currentPhase;
                            scoreElement.textContent = `Score: ${score}`;

                            phaseProgress++;
                            const goalIndex = currentPhase - 1;
                            if (goalIndex < phaseGoals.length && typeof phaseGoals[goalIndex] === 'number' && phaseGoals[goalIndex] > 1) {
                                if (phaseProgress >= phaseGoals[goalIndex]) {
                                    advancePhase();
                                }
                            }

                            hit = true;
                            break;
                        }
                    }
                }

                if (hit) {
                    if (bullet.parentNode === gameContainer) gameContainer.removeChild(bullet);
                    bullets.splice(i, 1);
                }
            }

            if (!isPlayerInvulnerable && !isBossActive) {
                const playerRect = player.getBoundingClientRect();
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    if (!enemy) continue;
                    const enemyRect = enemy.getBoundingClientRect();

                    if (
                        playerRect.left < enemyRect.right - 5 &&
                        playerRect.right > enemyRect.left + 5 &&
                        playerRect.top < enemyRect.bottom - 5 &&
                        playerRect.bottom > enemyRect.top + 5
                    ) {
                        createExplosion(enemyRect.left + enemyRect.width / 2, enemyRect.top + enemyRect.height / 2);
                        if (enemy.parentNode === gameContainer) gameContainer.removeChild(enemy);
                        enemies.splice(i, 1);
                        playerTakeDamage(25);
                        if (isGameOver) return;
                        break;
                    }
                }
            }
        }
        
        function gameOver() {
            if (isGameOver) return;
            isGameOver = true;
            finalScoreElement.textContent = `Score: ${score}`;
            saveHighScore();
            gameOverScreen.style.display = 'flex';
            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            deactivateSpecial();
            player.style.display = 'none';

            playSound(sfxGameOver);
            stopMusic();
            playSound(bgmGameOver);

            isPlayerInvulnerable = false;
            player.classList.remove('invulnerable');
            if (playerInvulnerableTimer) clearTimeout(playerInvulnerableTimer);
            bossElement.style.display = 'none';
            bossHPContainer.style.display = 'none';
        }
        
        function resetGame() {
            stopMusic();
            loadHighScore();

            bullets.forEach(b => { if(b.parentNode === gameContainer) gameContainer.removeChild(b); });
            bullets = [];
            enemies.forEach(e => { if(e.parentNode === gameContainer) gameContainer.removeChild(e); });
            enemies = [];
            enemyBullets.forEach(eb => { if(eb.parentNode === gameContainer) gameContainer.removeChild(eb); });
            enemyBullets = [];

            playerX = containerWidth / 2 - playerWidth / 2;
            playerY = containerHeight - playerHeight - 20;
            playerCurrentHP = playerMaxHP;
            isPlayerInvulnerable = false;
            if (playerInvulnerableTimer) clearTimeout(playerInvulnerableTimer);
            score = 0;
            currentPhase = 1;
            phaseProgress = 0;
            isBossActive = false;
            bossData = {};
            specialCharges = 3;
            isGameOver = false;
            isSpecialActive = false;
            lastEnemySpawnTime = 0;

            scoreElement.textContent = `Score: ${score}`;
            updatePlayerHPBar();
            phaseDisplay.textContent = `Fase: ${currentPhase}`;
            specialChargesElement.textContent = `Tiro Especial: ${specialCharges}`;
            gameOverScreen.style.display = 'none';
            specialActiveElement.style.display = 'none';
            specialBarFill.style.width = '0%';
            player.style.display = 'block';
            player.classList.remove('invulnerable');
            bossElement.style.display = 'none';
            bossHPContainer.style.display = 'none';

            createStars();
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoopId = null;
            startGame();
        }
        
        function enableAutoFire() {
            setInterval(() => {
                if (!isGameOver) {
                    fireBullet();
                }
            }, 300);
        }
        
        function gameLoop() {
            if (!isGameOver) {
                updatePlayer();
                if (isFirePressed) {
                    fireBullet();
                }
                if (isSpecialPressed && !isSpecialActive && specialCharges > 0) {
                    activateSpecial();
                    isSpecialPressed = false;
                }
                updateBullets();
                updateEnemyBullets();
                createEnemy();
                updateEnemies();
                updateStars();
                checkCollisions();
                gameLoopId = requestAnimationFrame(gameLoop);
            }
        }
        
        function setupControls() {
            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') {
                    isLeftPressed = true;
                }
                if (e.key === 'ArrowRight' || e.key === 'd') {
                    isRightPressed = true;
                }
                if (e.key === 'ArrowUp' || e.key === 'w') {
                    isFirePressed = true;
                }
                if (e.key === ' ' && !isSpecialPressed) {
                    isSpecialPressed = true;
                }
            });
            
            window.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') {
                    isLeftPressed = false;
                }
                if (e.key === 'ArrowRight' || e.key === 'd') {
                    isRightPressed = false;
                }
                if (e.key === 'ArrowUp' || e.key === 'w') {
                    isFirePressed = false;
                }
                if (e.key === ' ') {
                    isSpecialPressed = false;
                }
            });
            
            let touchStartX = 0;
            gameContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const containerRect = gameContainer.getBoundingClientRect();
                touchStartX = touch.clientX - containerRect.left;
                
                const now = new Date().getTime();
                const timeSince = now - (touch.target.lastTouch || 0);
                
                if (timeSince < 300 && timeSince > 0) {
                    isSpecialPressed = true;
                }
                
                touch.target.lastTouch = now;
                isFirePressed = true;
            });
            
            gameContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const containerRect = gameContainer.getBoundingClientRect();
                const touchX = touch.clientX - containerRect.left;
                
                if (touchX < touchStartX - 20) {
                    isLeftPressed = true;
                    isRightPressed = false;
                } else if (touchX > touchStartX + 20) {
                    isLeftPressed = false;
                    isRightPressed = true;
                } else {
                    isLeftPressed = false;
                    isRightPressed = false;
                }
                
                playerX = touchX - playerWidth / 2;
                if (playerX < 0) playerX = 0;
                if (playerX > containerWidth - playerWidth) playerX = containerWidth - playerWidth;
            });
            
            gameContainer.addEventListener('touchend', () => {
                isFirePressed = false;
                isLeftPressed = false;
                isRightPressed = false;
            });
            
            restartButton.addEventListener('click', resetGame);
        }
        
        function startGame() {
            if (!window.controlsInitialized) {
                setupControls();
                enableAutoFire();
                window.controlsInitialized = true;
            }
            stopMusic();
            playSound(bgmGame);
            if (!gameLoopId) {
               gameLoopId = requestAnimationFrame(gameLoop);
            }
        }
        
        function updatePlayerHPBar() {
            const percentage = (playerCurrentHP / playerMaxHP) * 100;
            playerHPBarFill.style.width = `${Math.max(0, percentage)}%`;
        }
        
        function playerTakeDamage(damage) {
            if (isPlayerInvulnerable) return;

            playerCurrentHP -= damage;
            updatePlayerHPBar();
            playSound(sfxPlayerDamage);
            triggerScreenShake();

            if (playerCurrentHP <= 0) {
                createExplosion(playerX + playerWidth / 2, playerY + playerHeight / 2);
                player.style.display = 'none';
                gameOver();
            } else {
                isPlayerInvulnerable = true;
                player.classList.add('invulnerable');
                if (playerInvulnerableTimer) clearTimeout(playerInvulnerableTimer);
                playerInvulnerableTimer = setTimeout(() => {
                    isPlayerInvulnerable = false;
                    player.classList.remove('invulnerable');
                    playerInvulnerableTimer = null;
                }, playerInvulnerableDuration);
            }
        }
        
        function triggerScreenShake() {
            gameContainer.classList.add('shake');
            setTimeout(() => {
                gameContainer.classList.remove('shake');
            }, 150);
        }
        
        function spawnBoss() {
            console.log("Spawning Boss for Phase", currentPhase);
            isBossActive = true;
            bossElement.style.display = 'block';
            bossHPContainer.style.display = 'block';

            bossData = {
                maxHP: 300 + (currentPhase * 100),
                currentHP: 0,
                x: containerWidth / 2 - 50,
                y: 30,
                speedX: 1.5 + (currentPhase * 0.2),
                directionX: 1,
                attackTimer: 0,
                attackInterval: 1500 - (currentPhase * 100),
                lastAttackTime: 0
            };
            bossData.currentHP = bossData.maxHP;
            bossElement.style.left = bossData.x + 'px';
            bossElement.style.top = bossData.y + 'px';
            updateBossHPBar();

            enemies.forEach(enemy => {
                if(enemy.parentNode === gameContainer) gameContainer.removeChild(enemy);
            });
            enemies = [];
        }
        
        function updateBossHPBar() {
            const percentage = (bossData.currentHP / bossData.maxHP) * 100;
            bossHPFill.style.width = `${Math.max(0, percentage)}%`;
        }
        
        function updateBoss() {
            if (!isBossActive) return;

            bossData.x += bossData.speedX * bossData.directionX;
            if (bossData.x <= 10 || bossData.x >= containerWidth - 110) {
                bossData.directionX *= -1;
                bossData.x = Math.max(10, Math.min(bossData.x, containerWidth - 110));
            }
            bossElement.style.left = bossData.x + 'px';

            const now = Date.now();
            if (now - bossData.lastAttackTime > bossData.attackInterval) {
                bossData.lastAttackTime = now;
                const cannonLeftX = bossData.x + 25;
                const cannonRightX = bossData.x + 75;
                const cannonY = bossData.y + 90;

                bossFireBullet(cannonLeftX, cannonY, 0, 3 + currentPhase * 0.5);
                bossFireBullet(cannonRightX, cannonY, 0, 3 + currentPhase * 0.5);
            }
        }
        
        function bossTakeDamage(damage) {
            if (!isBossActive) return;
            bossData.currentHP -= damage;
            updateBossHPBar();
            playSound(sfxEnemyHit);

            bossElement.style.filter = 'brightness(1.8)';
            setTimeout(() => { bossElement.style.filter = 'brightness(1)'; }, 100);

            if (bossData.currentHP <= 0) {
                defeatBoss();
            }
        }
        
        function defeatBoss() {
            console.log("Boss Defeated!");
            isBossActive = false;
            createExplosion(bossData.x + 50, bossData.y + 50);
            bossElement.style.display = 'none';
            bossHPContainer.style.display = 'none';

            score += 500 * currentPhase;
            scoreElement.textContent = `Score: ${score}`;
            if (specialCharges < 3) {
                 specialCharges++;
                 specialChargesElement.textContent = `Tiro Especial: ${specialCharges}`;
            }
             playerCurrentHP = Math.min(playerMaxHP, playerCurrentHP + 25);
             updatePlayerHPBar();

            advancePhase();
        }
        
        function advancePhase() {
            currentPhase++;
            phaseProgress = 0;
            phaseDisplay.textContent = `Fase: ${currentPhase}`;
            console.log(`Advanced to Phase ${currentPhase}`);

            const goalIndex = currentPhase - 1;
            if (goalIndex < phaseGoals.length && typeof phaseGoals[goalIndex] === 'number' && phaseGoals[goalIndex] === 1) {
                spawnBoss();
            } else if (goalIndex >= phaseGoals.length) {
                console.log("Todas as fases definidas completas!");
            }
            showPhaseNotification(`Fase ${currentPhase} Iniciada!`);
        }
        
        function showPhaseNotification(message) {
            let notification = document.getElementById('phase-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'phase-notification';
                notification.style.position = 'absolute';
                notification.style.top = '40%';
                notification.style.left = '50%';
                notification.style.transform = 'translate(-50%, -50%)';
                notification.style.padding = '15px 30px';
                notification.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                notification.style.color = '#0f0';
                notification.style.fontSize = '24px';
                notification.style.fontWeight = 'bold';
                notification.style.borderRadius = '10px';
                notification.style.zIndex = '20';
                notification.style.display = 'none';
                gameContainer.appendChild(notification);
            }
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }
        
        function loadHighScore() {
            const storedScore = localStorage.getItem('spaceShooterHighScore');
            highScore = storedScore ? parseInt(storedScore, 10) : 0;
            highScoreElement.textContent = `High Score: ${highScore}`;
        }
        
        function saveHighScore() {
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('spaceShooterHighScore', highScore);
                highScoreElement.textContent = `High Score: ${highScore}`;
            }
        }
        
        function updateEnemyBullets() {
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                const x = parseFloat(bullet.style.left);
                const y = parseFloat(bullet.style.top) + bullet.speedY;

                if (y > containerHeight || y < -20 || x < -10 || x > containerWidth + 10) {
                    if (bullet.parentNode === gameContainer) gameContainer.removeChild(bullet);
                    enemyBullets.splice(i, 1);
                } else {
                    bullet.style.top = y + 'px';
                    bullet.style.left = x + (bullet.speedX || 0) + 'px';
                }
            }
        }
        
        function bossFireBullet(startX, startY, speedX, speedY) {
            const bullet = document.createElement('div');
            bullet.className = 'enemy-bullet';
            bullet.style.left = startX + 'px';
            bullet.style.top = startY + 'px';
            bullet.speedX = speedX;
            bullet.speedY = speedY;
            gameContainer.appendChild(bullet);
            enemyBullets.push(bullet);
        }
        
        window.controlsInitialized = false;
        loadHighScore();
        resetGame();
    </script>
</body>
</html>