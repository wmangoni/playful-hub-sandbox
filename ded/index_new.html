<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-KM6SHZXP');</script>
        <!-- End Google Tag Manager -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- ... outros links e meta tags ... -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <!-- Inclui Lato para corpo e Cinzel Decorative para títulos/botões -->
        <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
        <title>RPG Adventure Quest</title>
        <style>
            body {
                /* Fonte serifada para texto principal, mais legível que apenas serif */
                font-family: 'Source Serif 4', Palatino, Georgia, serif;
                /* Fundo texturizado escuro (Ex: pergaminho queimado ou pedra escura) */
                background-color: #3a342a; /* Tom de marrom escuro */
                /* Padrão sutil opcional */
                /* background-image: linear-gradient(45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.05) 75%, rgba(0, 0, 0, 0.05)),
                                 linear-gradient(-45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.05) 75%, rgba(0, 0, 0, 0.05));
                background-size: 30px 30px; */
                color: #d1c7b8; /* Cor de texto padrão (bege claro) */
                max-width: 100%;
                margin: 0 auto;
                padding: 15px; /* Reduzir padding global */
                box-sizing: border-box; /* Inclui padding/border na largura/altura */
            }

            audio { /* Mantém o estilo do áudio */
                position: absolute;
                top: 8px; left: 8px; /* Ajustar posição */
                box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
                border-radius: 30px;
                opacity: 0.8; /* Leve transparência */
                z-index: 11;
            }

            /* --- Container Principal --- */
            .game-container {
                background-color: rgba(50, 40, 30, 0.6); /* Marrom escuro semi-transparente */
                border: 3px solid #c5a880; /* Borda dourada/bege envelhecida */
                border-radius: 5px; /* Menos arredondado */
                padding: 20px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6), inset 0 0 15px rgba(0,0,0,0.3); /* Sombra externa + interna */
                height: 95vh; /* Ajustar altura se necessário */
                max-height: 800px; /* Limite */
                /* Grid continua o mesmo */
                 display: grid;
                 grid-template-columns: repeat(5, 1fr);
                 grid-template-rows: auto 1fr; /* Linha do título + linha do grid principal */
                 gap: 15px; /* Aumentar espaço entre colunas/linhas do grid */
                 grid-template-areas: /* Definir áreas para título e grid */
                     "header header header header header"
                     "col1 col1 col2 col2 col3";
            }

            /* --- Layout Grid (Colunas) --- */
             /* Posicionamento pelo grid-template-areas */
            #header-area { grid-area: header; text-align: center; margin-bottom: 5px; } /* Nova área para título/subtítulo */
            #col1-area { grid-area: col1; display: flex; flex-direction: column; } /* Usar flex para empilhar */
            #col2-area { grid-area: col2; }
            #col3-area { grid-area: col3; display: flex; flex-direction: column;} /* Log com flex */

            /* --- Títulos --- */
            h1 {
                font-family: 'MedievalSharp', cursive; /* Fonte temática */
                color: #e8d0a8; /* Dourado mais claro */
                text-align: center;
                font-size: 2.2em; /* Maior */
                margin-bottom: 0px; /* Remover margem inferior */
                text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
                letter-spacing: 1px;
            }
            .subtitle {
                text-align: center;
                font-style: italic;
                margin-bottom: 15px; /* Menor espaço */
                color: #a0907c; /* Cinza/Bege */
                font-size: 0.9em;
            }

            /* --- Descrição da Cena --- */
            .scene-description {
                border-left: 5px solid #a06b3e; /* Borda marrom mais destacada */
                padding: 12px 18px;
                margin: 10px 0 15px 0; /* Ajustar margens */
                background-color: rgba(30, 25, 20, 0.7); /* Fundo escuro levemente transparente */
                color: #e0dacd; /* Texto mais claro */
                overflow-y: auto; /* Mudar para auto se quiser scroll só quando necessário */
                max-height: 25vh; /* Aumentar altura máxima */
                border-radius: 0 3px 3px 0; /* Arredondar cantos direitos */
                font-size: 1.05em; /* Ligeiramente maior */
                line-height: 1.6;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            }

            /* --- Status --- */
            .stats {
                display: flex;
                justify-content: space-around; /* Mais espaço entre stats */
                background-color: rgba(100, 80, 60, 0.3); /* Fundo marrom mais sutil */
                padding: 12px;
                border-radius: 4px;
                margin: 0 0 15px 0; /* Margem inferior apenas */
                border: 1px solid #604a30;
                text-align: center; /* Centralizar texto dentro de .stat */
            }
            .stat div:first-child { /* Nome do stat */
                font-size: 0.85em;
                color: #c0b098; /* Cor mais clara para nome */
                margin-bottom: 3px;
            }
            .stat-value {
                font-weight: bold;
                font-size: 1.2em; /* Ligeiramente maior */
                color: #ffffff; /* Branco para destacar valor */
            }

            /* --- Escolhas --- */
            .choices {
                display: flex;
                flex-direction: column;
                gap: 8px; /* Menor espaçamento entre botões */
                margin-top: auto; /* Empurra para baixo na col1 */
                padding-top: 15px; /* Espaço acima dos botões */
            }
            button { /* Estilo base para TODOS os botões */
                font-family: 'MedievalSharp', cursive; /* Fonte Temática */
                background: linear-gradient(to bottom, #8b5a2b, #6a421a); /* Marrom */
                color: #f0e0d0;
                border: 1px solid #4a3010;
                border-radius: 3px; /* Menos arredondado */
                padding: 10px 15px;
                cursor: pointer;
                font-size: 1.1em; /* Maior */
                text-align: center;
                text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
                transition: all 0.15s ease;
                box-shadow: 0 2px 2px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
                margin: 0; /* Resetar margem padrão */
            }
            button:hover:not(:disabled) {
                background: linear-gradient(to bottom, #a06a3b, #8b5a2b);
                color: #ffffff;
                box-shadow: 0 3px 4px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            }
            
            button:active:not(:disabled) {
                 transform: translateY(1px);
                 box-shadow: 0 1px 1px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            }

            button:disabled { /* Estilo para botão desabilitado */
                background: linear-gradient(to bottom, #666, #444);
                color: #999;
                cursor: not-allowed;
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
                text-shadow: none;
            }

            /* --- Imagem --- */
            #image-container {
                 padding: 0; /* Remover padding se não necessário */
                 display: flex; /* Para centralizar imagem */
                 align-items: center;
                 justify-content: center;
                 background-color: #1a1612; /* Fundo bem escuro */
                 border-radius: 3px;
                 box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
                 /* Manter altura ou usar aspect-ratio */
                 /* height: 100%; */ /* Ocupa altura da célula grid */
                 min-height: 300px; /* Garantir altura mínima */
            }
            #image-container img {
                max-width: 100%;
                max-height: 100%; /* Imagem não excede o container */
                object-fit: contain; /* Mantém proporção */
                border: 2px solid #504030; /* Borda interna sutil */
                border-radius: 2px;
            }

            /* --- Inventário --- */
            .inventory {
                margin: 0; /* Remover margem superior se stats já tem inferior */
                padding: 12px;
                background-color: rgba(100, 80, 60, 0.3); /* Igual stats */
                border-radius: 4px;
                border: 1px solid #604a30;
                flex-shrink: 0; /* Não encolher na coluna flex */
                 /* min-height: 100px; */ /* Altura mínima opcional */
            }
            .inventory h3 {
                font-family: 'MedievalSharp', cursive; /* Fonte Temática */
                margin-top: 0;
                margin-bottom: 8px;
                color: #e0b070; /* Dourado pálido */
                font-size: 1.1em;
                border-bottom: 1px dashed #806a50;
                padding-bottom: 4px;
            }
            #inventory-items {
                 font-size: 0.95em;
                 color: #c0b0a0; /* Cor mais clara para itens */
                 list-style: none; /* Remove bullets se usar ul */
                 padding-left: 5px;
            }
            #inventory-items li { /* Se usar <li> */
                margin-bottom: 5px;
            }
            #inventory-items li::before {
                 color: #e0b070;
            }

            /* --- Dado --- */
            .dice-roll {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 15px 0; /* Reduzir margem */
                flex-shrink: 0; /* Não encolhe na coluna flex */
                gap: 15px; /* Espaço entre dado e botão */
            }
            .dice {
                width: 50px; height: 50px; /* Menor */
                background: linear-gradient(to bottom right, #ffffff, #e0e0e0); /* Gradiente sutil */
                border: 1px solid #555;
                border-radius: 6px;
                font-size: 1.8em; /* Maior */
                font-weight: bold;
                color: #333;
                box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
                 /* Font para o dado? */
            }
            .roll-button { /* Já estilizado pelo 'button' genérico */
                /* margin-left: 0; */ /* Remover margem se usar gap */
                 font-size: 1em; /* Tamanho do texto do botão de rolar */
            }

            /* --- Log --- */
            .log { /* Agora é #col3-area */
                 /* Remover estilos daqui, aplicados em #col3-area e #game-log */
             }
            #game-log {
                /* Estilos já aplicados acima */
                /* Garantir max-height para funcionar com flex */
                max-height: calc(95vh - 260px);
                overflow: auto;
            }

            /* --- Seleção de Personagem --- */
            #character-select { /* Container geral */
                background-color: rgba(50, 40, 30, 0.8); /* Fundo para a seleção */
                padding: 30px;
                border-radius: 5px;
                border: 1px solid #705a40;
                 grid-column: 1 / -1; /* Ocupa todas as colunas */
                 grid-row: 1 / -1; /* Ocupa todas as linhas (sobrepõe o grid principal) */
                 z-index: 10; /* Fica por cima */
                 display: flex; /* Alterar para flex para melhor controle */
                 flex-direction: column;
                 align-items: center;
            }
            #character-select h2 {
                font-family: 'MedievalSharp', cursive;
                color: #e8d0a8;
                margin-bottom: 25px;
                font-size: 1.8em;
            }
            .character-select { /* O container dos cards */
                display: flex;
                gap: 20px; /* Maior espaçamento */
                justify-content: center;
                margin-bottom: 30px;
                flex-wrap: wrap; /* Permite quebrar linha se necessário */
            }
            .character-card {
                border: 2px solid #907050; /* Borda marrom/dourada */
                border-radius: 4px;
                padding: 18px;
                text-align: center;
                cursor: pointer;
                width: 180px; /* Maior */
                background: linear-gradient(to bottom, #605040, #4a3a2a); /* Fundo do card */
                transition: all 0.2s ease-in-out;
                color: #c0b0a0; /* Cor base do texto */
                box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            }
             .character-card h3 {
                 font-family: 'MedievalSharp', cursive;
                 color: #f0e0c0; /* Cor do nome */
                 margin-top: 0; margin-bottom: 10px;
                 font-size: 1.2em;
             }
             .character-card p {
                 font-size: 0.9em;
                 line-height: 1.4;
                 margin-bottom: 8px;
             }
             .character-card p strong {
                 color: #f0d0b0; /* Cor dos stats */
             }
            .character-card:hover {
                transform: translateY(-4px) scale(1.03);
                box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
                border-color: #e0c090; /* Borda mais clara no hover */
            }
            .character-card.selected {
                border-color: #ffb030; /* Borda dourada brilhante */
                background: linear-gradient(to bottom, #7a6a5a, #605040);
                transform: scale(1.02); /* Leve aumento */
                 box-shadow: 0 4px 10px rgba(255, 180, 50, 0.3);
            }
             /* Botão Iniciar Aventura */
             #character-select button {
                font-size: 1.2em; /* Botão maior */
                padding: 12px 25px;
            }

            /* --- Mensagem Resultado (Check) --- */
            .result-message {
                padding: 10px 15px; /* Menor padding */
                margin: 10px auto; /* Centralizar e reduzir margem */
                border-radius: 4px;
                font-weight: bold;
                font-size: 1.1em; /* Ligeiramente maior */
                text-align: center;
                border: 1px solid; /* Adiciona borda */
                max-width: 80%; /* Limita largura */
                 box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
            .success { /* Sucesso verde */
                background-color: rgba(80, 150, 80, 0.3); /* Fundo verde mais sutil */
                color: #90ee90; /* Verde claro */
                border-color: #60a060;
            }
            .failure { /* Falha vermelha */
                background-color: rgba(150, 80, 80, 0.3); /* Fundo vermelho mais sutil */
                color: #f0a0a0; /* Vermelho claro */
                border-color: #a06060;
            }

            /* --- Loja Modal --- */
            .modal { /* Container que escurece */
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.75); /* Mais escuro */
                display: flex; justify-content: center; align-items: center;
                z-index: 100; /* Garantir que está por cima */
            }
            .modal-content { /* Janela da loja */
                background: linear-gradient(to bottom, #5a4a3a, #403020); /* Fundo da janela */
                border: 3px ridge #c5a880; /* Borda dourada tipo relevo */
                padding: 25px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
                font-family: 'Source Serif 4', serif;
                text-align: center;
                color: #e0dacd; /* Texto claro */
                border-radius: 5px;
                width: 90%; /* Mais responsivo */
                max-width: 450px; /* Limite */
            }
             .modal-content h2 { /* Título da loja */
                 font-family: 'MedievalSharp', cursive;
                 color: #e8d0a8; /* Dourado */
                 margin-top: 0; margin-bottom: 15px;
                 font-size: 1.6em;
                 border-bottom: 1px solid #907050;
                 padding-bottom: 8px;
             }
             #player-gold { /* Ouro na loja */
                font-weight: bold;
                font-size: 1.1em;
                margin-bottom: 20px;
                color: #ffd700; /* Dourado brilhante */
            }
            .shop-items { /* Container dos itens */
                display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;
            }
            .shop-item { /* Botão do item */
                /* Usar estilo base do 'button' */
                 /* Talvez um fundo ligeiramente diferente? */
                 background: linear-gradient(to bottom, #705030, #50381a);
             }
            #close-shop { /* Botão fechar (já pega estilo base) */
                margin-top: 15px;
                 /* Fundo vermelho para fechar? */
                 /* background: linear-gradient(to bottom, #a04040, #802020); */
            }


            /* --- Botão TTS --- */
            #tts-toggle-button {
                position: absolute;
                top: 8px; /* Alinhar com áudio */
                left: calc(8px + 250px + 10px); /* Posicionar depois do áudio (ajustar 250px se largura do audio mudar) */
                z-index: 20; /* Sobrepor elementos do jogo */
                font-size: 18px; /* Ícone maior */
                padding: 5px 8px;
                background: rgba(80, 70, 60, 0.7); /* Fundo sutil */
                color: #e0dacd;
                border: 1px solid #605040;
                border-radius: 50%; /* Botão redondo */
                cursor: pointer;
                line-height: 1; /* Alinhar ícone verticalmente */
                opacity: 0.9;
                 transition: background-color 0.2s, opacity 0.2s;
             }
             #tts-toggle-button:hover {
                 background: rgba(100, 90, 80, 0.8);
                 opacity: 1;
             }

             /* --- Mensagem Info (Opcional) --- */
             #info { /* Ex: "Clique para iniciar" */
                position: fixed; /* Fixo na tela */
                bottom: 10px; /* Posição inferior */
                left: 50%;
                transform: translateX(-50%);
                 font-size: 0.9em;
                 color: #ccc;
                 background-color: rgba(0,0,0,0.6);
                 padding: 5px 10px;
                 border-radius: 3px;
                 z-index: 101; /* Acima de tudo */
             }


            /* Esconder elementos */
            .hidden { display: none !important; }
        </style>
    </head>
    <body>
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KM6SHZXP"
        height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <!-- End Google Tag Manager (noscript) -->
        
        <audio controls autoplay loop>
          <source src="audio/medieval-music.mp3" type="audio/mpeg" />
          Seu navegador não suporta o elemento de áudio.
        </audio>

        <!-- Adicionar botão de TTS -->
        <button id="tts-toggle-button" style="position: absolute; top: 74px; left: 24px; z-index: 11; font-size: 16px; padding: 3px 6px;">
            🔊 Narrador
        </button>
        <!-- Fim botão TTS -->

        <div class="game-container">
            <!-- Área para Título e Subtítulo -->
            <div id="header-area">
                <h1>A Masmorra de Drakmor</h1>
                <p class="subtitle">Uma Aventura Simples de D&D</p>
            </div>

            <div id="character-select">
                <h2 style="text-align: center;">Escolha o Seu Personagem</h2>
                <div class="character-select">
                    <div class="character-card" data-class="warrior" onclick="selectCharacter('warrior')">
                        <h3>Guerreiro</h3>
                        <p>Força e saúde elevadas, habilidoso com armas</p>
                        <p>
                            <strong>FOR:</strong> 16 <strong>DES:</strong> 12 <br>
                            <strong>CON:</strong> 15 <strong>INT:</strong> 8
                        </p>
                    </div>
                    <div class="character-card" data-class="wizard" onclick="selectCharacter('wizard')">
                        <h3>Mago</h3>
                        <p>Mestre em magia arcana com feitiços poderosos</p>
                        <p>
                            <strong>FOR:</strong> 8 <strong>DES:</strong> 14 <br>
                            <strong>CON:</strong> 10 <strong>INT:</strong> 17
                        </p>
                    </div>
                    <div class="character-card" data-class="rogue" onclick="selectCharacter('rogue')">
                        <h3>Ladino</h3>
                        <p>Ágil e astuto, habilidoso em furtividade</p>
                        <p>
                            <strong>FOR:</strong> 10 <strong>DES:</strong> 17 <br>
                            <strong>CON:</strong> 12 <strong>INT:</strong> 14
                        </p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="startGame()">Começar Aventura</button>
                </div>
            </div>

            <!-- Coluna 1 (Painel Esquerdo) -->
            <div id="col1-area">
                <div id="game-screen" class="hidden">
                    <div class="stats">
                        <div class="stat">
                            <div>❤️ Vida</div>
                            <div class="stat-value" id="health">20</div>
                        </div>
                        <div class="stat">
                            <div>🪙 Ouro</div>
                            <div class="stat-value" id="gold">5</div>
                        </div>
                        <div class="stat">
                            <div>📈 Experiência</div>
                            <div class="stat-value" id="xp">0</div>
                        </div>
                    </div>
                    <div class="scene-description" id="scene-text"></div>
                    <div id="dice-interaction-area">
                        <div id="dice-container" class="hidden dice-roll">
                            <div class="dice" id="dice">?</div>
                            <button id="dice-button" class="roll-button" onclick="rollDice()">🎲 Rolar d20</button>
                        </div>
                        <div id="result-message" class="hidden result-message"></div>
                    </div>
                    <div class=choices id=choices></div>
                    <div class="inventory">
                        <h3>🎒 Inventário</h3>
                        <div id="inventory-items"> Nada ainda </div>
                    </div>
                    <div class="hidden"> <!-- Container para botão da loja -->
                        <button id="open-shop">🛒 Abrir Loja</button>
                    </div>
                </div>
            </div>
            <!-- Coluna 2 (Imagem) -->
            <div id="col2-area" class="hidden"> <!-- Classe hidden aqui para controlar visibilidade da coluna -->
                <div id="image-container"> <!-- Remover classe col2 daqui -->
                    <img id="image" src="./images/placeholder.png" alt="Cena Atual">
                </div>
            </div>
            <!-- Coluna 3 (Log) -->
            <div id="col3-area" class="hidden"> <!-- Classe hidden aqui -->
                <div id="log-container">
                    <h3 id="log-title">Diário da Aventura</h3>
                    <div id="game-log"> <!-- Remover classe col3 e log daqui -->
                        <!-- Logs -->
                    </div>
                </div>
            </div>

        </div>
        <div id="shop-modal" class="modal hidden">
            <div class="modal-content">
                <h2>🏦 Lojinha</h2>
                <p id="player-gold">🪙 Ouro: 5</p>
                <div class="shop-items">
                    <button class="shop-item" data-item="Poção de Vida" data-price="10">🫙 Poção de Vida - 10g</button>
                    <button class="shop-item" data-item="Espada" data-price="32">⚔️ Espada - 32g</button>
                    <button class="shop-item" data-item="Machado" data-price="36">🪓 Machado - 36g</button>
                    <button class="shop-item" data-item="Adaga" data-price="45">💀 Adaga de osso estranha - 45g</button>
                    <button class="shop-item" data-item="Escudo" data-price="31">🛡️ Escudo - 31g</button>
                    <button class="shop-item" data-item="Corda" data-price="5">🪢 Corda - 5g</button>
                    <button class="shop-item" data-item="Tocha" data-price="2">🔦 Tocha - 2g</button>
                </div>
                <button id="close-shop">Fechar</button>
            </div>
        </div>
        <div id="game-over" class="hidden">...</div>

        <!-- Mensagem Info -->
        <div id="info">Clique ou Pressione Tecla para Iniciar</div>

        <script>
            // Estado do jogo
            const gameState = {
                player: {
                    class: "",
                    health: 20,
                    maxHealth: 20,
                    gold: 5,
                    xp: 0,
                    inventory: [],
                    stats: {}
                },
                mem: {},
                currentScene: "start",
                lastScene: "start",
                currentEnemy: {
                    name: "Wolf",
                    ac: 12,
                    hp: 12,
                    max_hp: 12,
                    str: 10,
                    dex: 10,
                    con: 10,
                    bba: 1
                },
                log: [],
                pendingCheck: null,
                checkDifficulty: 10
            };
            // Atributos do personagem
            const characterStats = {
                warrior: {
                    str: 16,
                    dex: 12,
                    con: 15,
                    int: 8,
                    luck: 8,
                    bba: 2,
                    armor: 6
                },
                wizard: {
                    str: 8,
                    dex: 14,
                    con: 10,
                    int: 17,
                    luck: 12,
                    bba: 1,
                    armor: 2
                },
                rogue: {
                    str: 10,
                    dex: 17,
                    con: 12,
                    int: 14,
                    luck: 10,
                    bba: 1,
                    armor: 4
                }
            };

            let currentTypewriterInterval = null;
            let skipTyping = false;

            var choicesElement = document.getElementById('choices');

            // --- Fase 2: TTS Variables ---
            let ttsEnabled = true; // Controle global para ativar/desativar TTS
            let synth = window.speechSynthesis; // Acesso à API de fala
            let voices = []; // Array para guardar as vozes disponíveis
            let selectedVoice = null; // Para guardar a voz pt-BR preferida
            let utterance = null; // Para guardar a instância da fala atual
            // Flag para indicar se a API de fala foi "desbloqueada" pela interação do usuário
            let speechApiUnlocked = false;

            // Cenas do jogo
            let scenes = {};
            fetch('assets/scenes.json')
                .then(response => response.json())
                .then(data => {
                    // Converter strings de função em funções reais
                    for (let sceneName in data) {
                        if (data[sceneName].onEnter) {
                            // Usando Function para criar uma nova função a partir da string
                            data[sceneName].onEnter = new Function('return ' + data[sceneName].onEnter)();
                        }
                    }
                    scenes = data;
                    // Iniciar o jogo após carregar as cenas
                    startGame();
                })
                .catch(error => {
                    console.error('Erro ao carregar as cenas:', error);
                    alert('Erro ao carregar o jogo. Por favor, recarregue a página.');
                });

            let selectedCharacter = null;

            /**
             * Tenta popular a lista de vozes disponíveis e selecionar uma voz pt-BR.
             * Precisa ser chamada APÓS a interação do usuário e/ou no evento 'voiceschanged'.
             */
            function populateVoiceList() {
                if (!synth) return; // Sai se a API não for suportada

                voices = synth.getVoices().sort(function (a, b) {
                    const aname = a.name.toUpperCase();
                    const bname = b.name.toUpperCase();
                    if (aname < bname) return -1;
                    else if (aname == bname) return 0;
                    else return +1;
                });
                console.log("Vozes disponíveis:", voices);

                // Tenta encontrar uma voz em Português do Brasil
                selectedVoice = voices.find(voice => voice.name.includes('Daniel - Portuguese') || voice.name.includes('Maria - Portuguese'));

                 // Fallback para outras pt-BR ou qualquer pt
                if (!selectedVoice) {
                     selectedVoice = voices.find(voice => voice.lang === 'pt-BR');
                }
                 if (!selectedVoice) {
                    selectedVoice = voices.find(voice => voice.lang.startsWith('pt-'));
                }
                 // Fallback final para a primeira voz disponível
                 if (!selectedVoice && voices.length > 0) {
                     selectedVoice = voices[0];
                 }

                 if (selectedVoice) {
                     console.log("Voz selecionada:", selectedVoice.name, selectedVoice.lang);
                 } else {
                     console.warn("Nenhuma voz pt-BR encontrada ou API não retornou vozes ainda.");
                 }
            }

            /**
             * Lê o texto fornecido usando a Web Speech API.
             * @param {string} text - O texto a ser lido.
             */
            function speakText(text) {
                if (!ttsEnabled || !synth || !speechApiUnlocked || !text) {
                     console.log("TTS desabilitado, API não pronta/desbloqueada ou texto vazio.");
                     return; // Sai se TTS desabilitado, API não disponível/desbloqueada ou texto vazio
                }

                // Cancela qualquer fala anterior para evitar sobreposição
                stopSpeech();

                // Cria a "declaração" (utterance)
                utterance = new SpeechSynthesisUtterance(text);

                utterance.onend = function() {
                    console.log("Narração concluída.");
                    utterance = null; // Limpa a referência
                };

                utterance.onerror = function(event) {
                    console.error("Erro na síntese de fala:", event.error);
                    utterance = null; // Limpa a referência
                };

                // Tenta usar a voz pt-BR selecionada
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                     utterance.lang = selectedVoice.lang; // Garante a língua correta
                 } else {
                     // Se nenhuma voz específica foi encontrada, define o idioma
                     // para dar uma dica ao navegador, mesmo que use a voz padrão.
                     utterance.lang = 'pt-BR';
                     console.warn("Usando voz padrão para pt-BR.");
                 }

                // (Opcional) Ajustar taxa e tom
                utterance.rate = 1.0; // 0.1 a 10 (1 = normal)
                utterance.pitch = 1.0; // 0 a 2 (1 = normal)

                // Tenta falar (pode precisar de resume se o contexto estava suspenso)
                if (synth.paused) {
                     synth.resume(); // Se estava pausado, retoma
                 }
                synth.speak(utterance);
                console.log("Tentando narrar:", text.substring(0, 30) + "...");
            }

            /**
             * Interrompe a narração atual.
             */
            function stopSpeech() {
                if (synth && synth.speaking) {
                    console.log("Cancelando narração anterior.");
                    synth.cancel();
                }
                // Também remove qualquer utterance pendente na fila, embora cancel() geralmente faça isso.
                 if (utterance) {
                    // utterance = null; // Não necessariamente nulo aqui, cancel deve tratar
                 }
            }

            // --- Fim Funções de Fala ---

            function selectCharacter(characterClass) {
                //Remove previous selection
                if (selectedCharacter) {
                    document.querySelector(`.character-card.selected`).classList.remove('selected');
                }
                selectedCharacter = characterClass;
                document.querySelector(`.character-card[data-class='${characterClass}']`).classList.add('selected');
            }

            /**
             * Exibe texto em um elemento com efeito de máquina de escrever.
             * @param {HTMLElement} element - O elemento HTML onde o texto será exibido.
             * @param {string} text - O texto completo a ser digitado.
             * @param {number} [speed=40] - O intervalo em milissegundos entre cada caractere.
             * @param {function} [callback] - Função a ser chamada quando a digitação terminar.
             * @returns {number} - O ID do intervalo (para poder limpar externamente).
             */
            function typewriterEffect(element, text, speed = 40, callback) {
                if (!element) {
                    console.error("Elemento para typewriter não encontrado!");
                    return null;
                }
                 if (currentTypewriterInterval) { // Limpa qualquer intervalo anterior
                    clearInterval(currentTypewriterInterval);
                }

                element.textContent = ''; // Limpa o texto inicial
                let i = 0;
                skipTyping = false; // Reseta a flag de pular

                currentTypewriterInterval = setInterval(() => {
                    if (skipTyping) { // Verifica se o jogador quer pular
                         clearInterval(currentTypewriterInterval);
                         currentTypewriterInterval = null;
                         element.textContent = text; // Exibe todo o texto
                         if (callback) callback(); // Executa o callback
                         return;
                     }

                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(currentTypewriterInterval); // Para o intervalo
                        currentTypewriterInterval = null;
                        skipTyping = false; // Reseta a flag ao concluir
                        if (callback) {
                            callback(); // Chama a função de callback ao terminar
                        }
                    }
                }, speed);

                return currentTypewriterInterval; // Retorna o ID para referência
            }

            /**
             * Função para habilitar os botões de escolha.
             */
            function enableChoices() {
                const choiceButtons = document.querySelectorAll('#choices button');
                choiceButtons.forEach(button => button.disabled = false);
                // Habilita novamente o clique para pular, se necessário (opcional)
                // setupSkipListener(); // Chamaria uma função que adiciona o listener se ele foi removido
            }

            /**
             * Função para desabilitar os botões de escolha.
             */
            function disableChoices() {
                 const choiceButtons = document.querySelectorAll('#choices button');
                 choiceButtons.forEach(button => button.disabled = true);
            }

            /**
             * Configura o listener para pular a digitação
             */
            function setupSkipListener() {
                const sceneTextElement = document.getElementById('scene-text');
                if (!sceneTextElement) return;

                // Remove listener antigo para evitar múltiplos gatilhos
                sceneTextElement.removeEventListener('click', handleSkipTyping);
                // Adiciona novo listener
                sceneTextElement.addEventListener('click', handleSkipTyping, { once: true }); // 'once: true' remove o listener após o primeiro clique
             }

            /**
             * Handler para o clique que pula a digitação
             */
            function handleSkipTyping() {
                if (currentTypewriterInterval) {
                    console.log("Pulando digitação...");
                    skipTyping = true; // Sinaliza para o intervalo terminar e exibir tudo
                }
            }

            function startGame() {
                if (!selectedCharacter) {
                    alert("⁉️ Escolha um personagem antes de iniciar a aventura.");
                    return;
                }
                //Initialize game state based on selected character
                gameState.player.class = selectedCharacter;
                gameState.player.stats = characterStats[selectedCharacter];
                gameState.player.health = gameState.player.maxHealth = 20; // Reset health for new game
                // Hide character selection and show game screen
                // document.getElementById('character-select').classList.add('hidden');
                // document.getElementById('game-screen').classList.remove('hidden');
                // document.getElementById('game-log').classList.remove('hidden');
                // document.getElementById('image-container').classList.remove('hidden');

                document.getElementById('character-select').classList.add('hidden');
                document.getElementById('col1-area').classList.remove('hidden');
                document.getElementById('col2-area').classList.remove('hidden');
                document.getElementById('col3-area').classList.remove('hidden');
                document.getElementById('game-screen').classList.remove('hidden');

                //Start the game with the 'start' scene
                loadScene('start');
                updateStatsDisplay();
            }

            function verificarImagem(idImagem, srcAlternativo) {
                const imagem = document.getElementById(idImagem);
                const src = imagem.src;

                const testeImagem = new Image();
                testeImagem.src = src;

                testeImagem.onload = function() {
                    console.log("Imagem carregada com sucesso!");
                    gameState.lastImage = src;
                };

                testeImagem.onerror = function() {
                    console.log("Erro ao carregar a imagem.");
                    if (srcAlternativo) {
                        imagem.src = srcAlternativo;
                        console.log("Imagem substituída por: " + srcAlternativo);

                        const testeImagem2 = new Image();
                        testeImagem2.src = srcAlternativo;

                        testeImagem2.onload = function() {
                            console.log("Imagem carregada com sucesso!");
                            gameState.lastImage = srcAlternativo;
                        };

                        testeImagem2.onerror = function() {
                            console.log("Erro ao carregar a imagem.");
                            if (srcAlternativo) {
                                imagem.src = gameState.lastImage;
                                console.log("Imagem substituída por: " + gameState.lastImage);
                            }
                        };
                    }
                };
            }

            function changeImage(sceneName) {
                const imgElement = document.getElementById("image");
                const src = "./images/"+sceneName;
                const extPng = ".png";
                const extJpg = ".jpeg";

                imgElement.src = src + extPng;
                verificarImagem("image", src + extJpg);
            }

            function loadScene(sceneName) {

                stopSpeech();

                // Limpa qualquer digitação anterior em andamento
                if (currentTypewriterInterval) {
                    clearInterval(currentTypewriterInterval);
                    currentTypewriterInterval = null;
                    skipTyping = false; // Reseta a flag
                }
                
                changeImage(sceneName);

                console.log("gameState", JSON.stringify(gameState, undefined, 4));
                console.log("sceneName", sceneName);
                
                gameState.currentScene = sceneName;
                const scene = scenes[sceneName];
                
                console.log("scene", scene);
                
                const sceneTextElement = document.getElementById('scene-text');
                if (!sceneTextElement) {
                    console.log("o elemento sumiu!");
                    const sceneTextDiv = document.createElement('div');
                    sceneTextDiv.id = 'scene-text';
                    sceneTextDiv.textContent = 'Esta é a cena do jogo!'; // Adiciona um texto de exemplo
                    // Encontra a div com o id "game-screen"
                    const gameScreenDiv = document.getElementById('game-screen');
                    if (gameScreenDiv == null || gameScreenDiv == undefined) {
                        console.log("cade essa bagaça de div?");
                    }
                    // Adiciona a div "scene-text" como filha da div "game-screen"
                    gameScreenDiv.appendChild(sceneTextDiv);
                    sceneTextElement = sceneTextDiv;
                }

                speakText(scene.text); // Tenta ler o texto da cena

                const diceContainer = document.getElementById('dice-container');
                const resultMessageElement = document.getElementById('result-message');
                console.log("sceneTextElement", sceneTextElement);

                sceneTextElement.textContent = '...'; // Placeholder enquanto digita

                // --- Modificação Principal ---
                disableChoices(); // Desabilita escolhas enquanto o texto é digitado

                choicesElement.innerHTML = ''; // Limpa escolhas antigas IMEDIATAMENTE

                diceContainer.classList.add('hidden'); // Esconde dados por padrão
                resultMessageElement.classList.add('hidden'); // Esconde mensagem por padrão

                //sceneTextElement.textContent = scene.text;

                // Inicia o efeito de digitação, passando a função para habilitar escolhas como callback
                typewriterEffect(sceneTextElement, scene.text, 40, () => {
                     // --- Este código executa DEPOIS que a digitação termina ---
                     console.log("Digitação concluída para:", sceneName);
                     // Adiciona as escolhas SOMENTE APÓS a digitação (ou skip)
                     addChoiceInCurrentScene(scene, diceContainer, choicesElement); // Passa choicesElement
                     enableChoices(); // Reabilita as escolhas
                 });

                 // Configura o listener para permitir pular a digitação atual
                 setupSkipListener();

                //Add choices for the current scene
                addChoiceInCurrentScene(scene, diceContainer);

                diceContainer.classList.add('hidden'); // Hide dice by default
                resultMessageElement.classList.add('hidden'); // Hide result message by default

                // Run onEnter function if it exists for the scene
                if (scene.onEnter) {
                    scene.onEnter();
                }
                // Reset check difficulty after scene load
                gameState.checkDifficulty = 10;
            }

            function addChoiceInCurrentScene(scene, diceContainer, choicesElement) {
                if (!choicesElement) {
                    choicesElement = document.getElementById('choices'); // Fallback se não for passado
                }

                //Clear existing choices
                choicesElement.innerHTML = '';

                scene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.textContent = choice.text;
                    button.onclick = () => {
                        
                        // Ao clicar na escolha, remove o listener de skip da cena atual
                        const sceneTextElement = document.getElementById('scene-text');
                        if (sceneTextElement) sceneTextElement.removeEventListener('click', handleSkipTyping);

                        if (choice.requiresCheck) {
                            gameState.mem = {
                                nextSceneSuccess: scenes[`${choice.nextScene}_success`] ? `${choice.nextScene}_success` : choice.nextScene,
                                nextSceneFailure: scenes[`${choice.nextScene}_failure`] ? `${choice.nextScene}_failure` : choice.nextScene,
                                checkType: choice.checkType
                            };
                            if (!diceContainer) {
                                diceContainer = document.getElementById('dice-container');
                            }
                            diceContainer.classList.remove('hidden');
                            choicesElement.classList.add('hidden'); // Hide choices during dice roll
                        } else {
                            loadScene(choice.nextScene);
                        }
                    };
                    choicesElement.appendChild(button);
                });

                choicesElement.classList.remove('hidden'); // Ensure choices are visible when scene loads
            }

            function rollingDice(sides = 6, num = 1) {
                return Array.from({length: num}, () => Math.floor(Math.random() * sides) + 1);
            }

            function activeDiceButton() {
                const diceButton = document.getElementById('dice-button');
                diceButton.disabled = false;
            }

            function disactiveDiceButton() {
                const diceButton = document.getElementById('dice-button');
                diceButton.disabled = true;
            }

            function rollDice() {
                //disabilitar o botão
                disactiveDiceButton();

                const diceResult = Math.floor(Math.random() * 20) + 1;
                document.getElementById('dice').textContent = diceResult;
                const resultMessageElement = document.getElementById('result-message');
                setTimeout(() => {
                    const diceContainer = document.getElementById('dice-container');
                    choicesElement = document.getElementById('choices');
                    let checkSuccess = false;

                    if (gameState.mem.checkType === "combat") {
                        initFight(gameState.currentEnemy);
                        checkSuccess = true;
                    } else {
                        let modifiedRoll = 0;

                        let logMessage = `Resultado da rolagem de dado: ${diceResult} para a categoria de teste: ${gameState.mem.checkType}. `;
                          
                        if (gameState.mem.checkType === 'luck') { // No stat modifier for luck checks - raw d20 roll.
                            modifiedRoll = diceResult; // Luck checks are raw d20 rolls
                        }

                        const statValue = Math.floor((gameState.player.stats[gameState.mem.checkType] - 10)/2); // Get relevant stat
                        modifiedRoll = diceResult;

                        if (statValue !== undefined) {
                            modifiedRoll += statValue;
                            logMessage += `\nModificador status +${statValue}. resultado da rolagem: ${modifiedRoll}. `;
                        }

                        if (modifiedRoll >= gameState.checkDifficulty) {
                            checkSuccess = true;
                            resultMessageElement.textContent = "Success!";
                            resultMessageElement.classList.remove('failure');
                            resultMessageElement.classList.add('success');
                            logMessage += `\n👍 Sucesso no teste de dificuldade: ${gameState.checkDifficulty}.`;
                        } else {
                            resultMessageElement.textContent = "Failure!";
                            resultMessageElement.classList.remove('success');
                            resultMessageElement.classList.add('failure');
                            logMessage += `\n👎 Falha no teste de dificuldade: ${gameState.checkDifficulty}.`;
                        }
                        resultMessageElement.classList.remove('hidden');
                        addToLog(logMessage);
                    }

                    diceContainer.classList.add('hidden');
                    choicesElement.classList.remove('hidden'); // Re-enable choices after roll
                    // Set timeout to load next scene after showing result message (e.g., 1.5 seconds)
                    setTimeout(() => {
                        console.log("gameState.mem", gameState.mem);
                        console.log("gameState.currentScene", gameState.currentScene);
                        if (checkSuccess) {
                            if (!gameState.mem.nextSceneSuccess) {
                                loadScene(gameState.currentScene + "_success");
                            } else {
                                loadScene(gameState.mem.nextSceneSuccess);
                            }
                        } else {
                            if (!gameState.mem.nextSceneFailure) {
                                loadScene(gameState.currentScene + "_failure");
                            } else {
                                loadScene(gameState.mem.nextSceneFailure);
                            }
                        }
                    }, 1000); // Wait 1.5 seconds before loading next scene
                    gameState.pendingCheck = null; //Clear pending check
                    document.getElementById('dice').textContent = "🎲"
                    activeDiceButton();
                }, 1500);
                
            }

            function initFight(enemy) {
                do {
                    fight(enemy)
                } while(enemy.hp > 0 && gameState.player.health > 0)
            }

            function fight(enemy) {

                let atkBonus = 0;

                if (gameState.player.inventory.includes("Adaga")) {
                    atkBonus = 2;
                    addToLog(`💀 A adaga de ossos lhe dá +${atkBonus} de ataque.`);
                }
                if (gameState.player.inventory.includes("Espada")) {
                    atkBonus = 3;
                    addToLog(`⚔️ A espada lhe dá +${atkBonus} de ataque.`);
                }
                if (gameState.player.inventory.includes("Machado")) {
                    atkBonus = 4;
                    addToLog(`🪓 O machado lhe dá +${atkBonus} de ataque.`);
                }
                
                let attackRoll = atkBonus + rollingDice(20)[0] + Math.floor((gameState.player.stats.str - 10)/2) + gameState.player.stats.bba;
                
                addToLog(`Você ataca o ${enemy.name} (AC ${enemy.ac})... Roll: ${attackRoll}`);
                
                if (attackRoll >= enemy.ac) {
                    const damage = rollingDice(8)[0] + Math.floor((gameState.player.stats.str - 10)/2);
                    addToLog(`🥊 Você acerta ${damage} de dano no inimigo!`);

                    enemy.hp -= damage;
                    
                    if (enemy.hp <= 0) {
                        const xpGain = 50;
                        const goldGain = rollingDice(6, 3).reduce((a, b) => a + b);
                        addToLog(`🎊 Você derrotou o ${enemy.name}! Ganhou ${xpGain} de XP e ${goldGain}g`);
                        gameState.player.xp += xpGain;
                        gameState.player.gold += goldGain;
                    } else {
                        addToLog(`🥊 O ${enemy.name} sobreviveu e te ataca!`);
                        enemyAttack(enemy)
                    }
                } else {
                    addToLog("Você errou!");
                    addToLog(`🥊 O ${enemy.name} te ataca!`);
                    enemyAttack(enemy)
                }
            }

            function enemyAttack(enemy) {
                let attackEnemy = rollingDice(20)[0] + Math.floor((gameState.player.stats.str - 10)/2) + gameState.player.stats.bba;
                let armorBonus = 0;
                if (gameState.player.inventory.includes("Escudo")) {
                    armorBonus = 4;
                    addToLog(`🛡️ O escudo lhe dá +${armorBonus} de armadura.`);
                }
                if (attackEnemy >= 10 + Math.floor((gameState.player.stats.dex - 10)/2) + gameState.player.stats.armor + armorBonus) {
                    addToLog(`🥊 O ${enemy.name} acerta você.`);
                    const enemyDamage = rollingDice(6)[0];
                    addToLog(`Você levou ${enemyDamage} de dano!`);
                    changeHealth(enemyDamage);
                } else {
                    addToLog(enemy.name + " miss!");
                }
            }

            function changeHealth(amount) {
                gameState.player.health += amount;
                if (gameState.player.health > gameState.player.maxHealth) gameState.player.health = gameState.player.maxHealth; // cap health
                if (gameState.player.health <= 0) {
                    gameState.player.health = 0;
                    addToLog("☠️☠️☠️ Você morreu pq perdeu todos os pontos de vida! ☠️☠️☠️");
                    loadScene('death'); // Load death scene
                }
                updateStatsDisplay();
            }

            function changeGold(amount) {
                gameState.player.gold += amount;
                if (gameState.player.gold < 0) gameState.player.gold = 0; // No negative gold
                if (amount > 0) {
                    addToLog("Você ganhou " + amount + " 🪙.");
                } else {
                    addToLog(amount + " 🪙 foi removido da sua mochila");
                }
                updateStatsDisplay();
            }

            function changeXP(amount) {
                gameState.player.xp += amount;
                updateStatsDisplay();
                addToLog("Você ganhou " + amount + " de XP." );
            }

            function addToInventory(item) {
                gameState.player.inventory.push(item);
                updateInventoryDisplay();
                addToLog(`Adicionado ${item} ao inventário.`);
            }

            function removeHealthPotionsFromInventory() {
                gameState.player.inventory = gameState.player.inventory.filter(item => item !== 'Poção de cura');
                updateInventoryDisplay();
            }

            function removeFromInventory(item) {
                const index = gameState.player.inventory.indexOf(item);
                if (index > -1) {
                    gameState.player.inventory.splice(index, 1);
                    updateInventoryDisplay();
                    addToLog(`Removido ${item} ao inventário.`);
                }
            }

            function haveMoney(amount) {
              if (amount < gameState.player.gold) {
                gameState.player.gold -= amount;
                addToLog(amount + " 🪙 foram removidas da sua mochila");
                updateStatsDisplay();
                return true;
              }

              return false;
            }

            function updateStatsDisplay() {
                document.getElementById('health').textContent = gameState.player.health;
                document.getElementById('gold').textContent = gameState.player.gold;
                document.getElementById('xp').textContent = gameState.player.xp;
            }

            function updateInventoryDisplay() {
                const inventoryItemsElement = document.getElementById('inventory-items');
                if (gameState.player.inventory.length === 0) {
                    inventoryItemsElement.textContent = "Mochila vazia!";
                } else {
                    inventoryItemsElement.innerHTML = ''; // Clear existing items
                    const ul = document.createElement('ul');
                    gameState.player.inventory.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        ul.appendChild(li);
                    });
                    inventoryItemsElement.appendChild(ul);
                }
            }

            function addToLog(message) {
                gameState.log.push(message);
                const logElement = document.getElementById('game-log');
                const logMessageElement = document.createElement('p');
                logMessageElement.textContent = message;
                logElement.appendChild(logMessageElement);
                logElement.scrollTop = logElement.scrollHeight; //Auto-scroll to bottom
            }

            // Selecionar elementos da lojinha
            const openShopButton = document.getElementById('open-shop');
            const closeShopButton = document.getElementById('close-shop');
            const shopModal = document.getElementById('shop-modal');
            const playerGoldElement = document.getElementById('player-gold');
            const shopItems = document.querySelectorAll('.shop-item');

            // Abrir a lojinha
            openShopButton.addEventListener('click', () => {
                playerGoldElement.textContent = `Ouro: ${gameState.player.gold}`;
                shopModal.classList.remove('hidden');
            });

            // Fechar a lojinha
            closeShopButton.addEventListener('click', () => {
                shopModal.classList.add('hidden');
            });

            // Comprar itens
            shopItems.forEach(item => {
                item.addEventListener('click', () => {
                    const itemName = item.getAttribute('data-item');
                    const itemPrice = parseInt(item.getAttribute('data-price'), 10);

                    if (gameState.player.gold >= itemPrice) {
                        gameState.player.gold -= itemPrice;
                        addToInventory(itemName);
                        playerGoldElement.textContent = `Ouro: ${gameState.player.gold}`;
                        addToLog(`Você comprou ${itemName} por ${itemPrice}g.`);
                        updateStatsDisplay(); // Atualiza o ouro na interface
                    } else {
                        addToLog("Ouro insuficiente para comprar este item.");
                    }
                });
            });

            function init() {
                // ... (configuração inicial: scene, camera, etc. se aplicável, ou elementos DOM)

                // Event Listeners para Teclado/Mouse/Toque (se houver, para o jogo em si)
                // document.addEventListener('keydown', handleKeyDown); // Exemplo se você tiver
                // gameContainer.addEventListener('click', handleGameClick); // Exemplo

                // --- Modificar listener de inicialização ---
                function initializeAudioAndSpeech() {
                     // Tenta inicializar/resumir AudioContext (se você usar áudio para outras coisas)
                     /*
                     if (!audioContext) {
                         try {
                             audioContext = new (window.AudioContext || window.webkitAudioContext)();
                             console.log("Audio Context Created on user gesture.");
                         } catch (e) { console.error("Error creating Audio Context:", e); }
                     }
                     if (audioContext && audioContext.state === 'suspended') {
                         audioContext.resume().catch(e => console.error("Error resuming AudioContext:", e));
                     }
                     */

                    // --- Inicialização da API de Fala ---
                    if (synth) { // Verifica se a API existe no navegador
                        if (!speechApiUnlocked) {
                             // Tenta "desbloquear" a API com uma chamada silenciosa ou resume
                             // synth.speak(new SpeechSynthesisUtterance('')); // Método comum, mas pode dar 'cancelled'
                            // Ou tenta retomar, pode ser suficiente em alguns navegadores
                             if (synth.paused) { synth.resume(); } // Se estiver pausado, retoma
                             if (synth.speaking) { synth.cancel(); } // Cancela algo que possa ter ficado preso

                            console.log("Tentativa de desbloquear Speech Synthesis API.");
                            speechApiUnlocked = true; // Assume que foi desbloqueado pela interação

                             // Popula a lista de vozes. A lista pode não estar pronta imediatamente.
                             // Opção 1: Tenta popular direto (pode não ter vozes ainda)
                             populateVoiceList();
                             // Opção 2: Tenta popular após um pequeno atraso
                              // setTimeout(populateVoiceList, 250);
                             // Opção 3 (Melhor): Usa o evento 'onvoiceschanged'
                             if (synth.onvoiceschanged !== undefined) {
                                 synth.onvoiceschanged = populateVoiceList;
                            }
                        }
                    } else {
                        console.warn("Web Speech API (speechSynthesis) não suportada neste navegador.");
                        ttsEnabled = false; // Desabilita TTS se não for suportado
                    }
                    // --- Fim Inicialização da Fala ---


                    // Atualiza UI e remove listeners
                    window.removeEventListener('click', initializeAudioAndSpeech);
                    window.removeEventListener('keydown', initializeAudioAndSpeech);
                    window.removeEventListener('touchstart', initializeAudioAndSpeech); // Adicionar touch
                 }

                // Adiciona listeners para a primeira interação
                window.addEventListener('click', initializeAudioAndSpeech, { once: true });
                window.addEventListener('keydown', initializeAudioAndSpeech, { once: true });
                window.addEventListener('touchstart', initializeAudioAndSpeech, { once: true }); // Adicionar touch

                // --- Início do Jogo ---
                // Não chame loadScene aqui, espere a seleção de personagem
                // initGame(); // Ou qualquer função que prepare a tela inicial
                updateStatsDisplay(); // Atualiza a UI inicial
                updateInventoryDisplay(); // Atualiza UI inicial

                // --- Controle Opcional de Mudo TTS ---
                const ttsToggleButton = document.getElementById('tts-toggle-button');

                function updateTtsButtonVisual() {
                     if (ttsToggleButton) {
                         ttsToggleButton.textContent = ttsEnabled ? '🔊 Narrador' : '🔇 Narrador';
                         ttsToggleButton.style.opacity = ttsEnabled ? '1' : '0.6';
                     }
                 }

                if (ttsToggleButton) {
                    ttsToggleButton.addEventListener('click', () => {
                        ttsEnabled = !ttsEnabled;
                        updateTtsButtonVisual();
                        if (!ttsEnabled) {
                            stopSpeech(); // Para a fala imediatamente se for desabilitado
                        }
                        console.log("TTS Habilitado:", ttsEnabled);
                    });
                    updateTtsButtonVisual(); // Define o estado inicial do botão
                }
                // --- Fim Controle Opcional ---
            }

            // Chame init() no final do script para configurar tudo
            init();

            function changeMusic(musicPath) {
                const audioElement = document.querySelector('audio');
                if (audioElement) {
                    audioElement.src = musicPath;
                    audioElement.play().catch(error => {
                        console.error('Erro ao tocar música:', error);
                    });
                }
            }

        </script>
    </body>
</html>