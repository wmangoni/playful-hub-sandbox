<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-KM6SHZXP');</script>
        <!-- End Google Tag Manager -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- ... outros links e meta tags ... -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <!-- Inclui Lato para corpo e Cinzel Decorative para t√≠tulos/bot√µes -->
        <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
        <title>RPG Adventure Quest</title>
        <style>
            body {
                /* Fonte serifada para texto principal, mais leg√≠vel que apenas serif */
                font-family: 'Source Serif 4', Palatino, Georgia, serif;
                /* Fundo texturizado escuro (Ex: pergaminho queimado ou pedra escura) */
                background-color: #3a342a; /* Tom de marrom escuro */
                /* Padr√£o sutil opcional */
                /* background-image: linear-gradient(45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.05) 75%, rgba(0, 0, 0, 0.05)),
                                 linear-gradient(-45deg, rgba(0, 0, 0, 0.05) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.05) 75%, rgba(0, 0, 0, 0.05));
                background-size: 30px 30px; */
                color: #d1c7b8; /* Cor de texto padr√£o (bege claro) */
                max-width: 100%;
                margin: 0 auto;
                padding: 15px; /* Reduzir padding global */
                box-sizing: border-box; /* Inclui padding/border na largura/altura */
            }

            audio { /* Mant√©m o estilo do √°udio */
                position: absolute;
                top: 8px; left: 8px; /* Ajustar posi√ß√£o */
                box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
                border-radius: 30px;
                opacity: 0.8; /* Leve transpar√™ncia */
            }

            /* --- Container Principal --- */
            .game-container {
                background-color: rgba(50, 40, 30, 0.6); /* Marrom escuro semi-transparente */
                border: 3px solid #c5a880; /* Borda dourada/bege envelhecida */
                border-radius: 5px; /* Menos arredondado */
                padding: 20px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6), inset 0 0 15px rgba(0,0,0,0.3); /* Sombra externa + interna */
                height: 95vh; /* Ajustar altura se necess√°rio */
                max-height: 800px; /* Limite */
                /* Grid continua o mesmo */
                 display: grid;
                 grid-template-columns: repeat(5, 1fr);
                 grid-template-rows: auto 1fr; /* Linha do t√≠tulo + linha do grid principal */
                 gap: 15px; /* Aumentar espa√ßo entre colunas/linhas do grid */
                 grid-template-areas: /* Definir √°reas para t√≠tulo e grid */
                     "header header header header header"
                     "col1 col1 col2 col2 col3";
            }

            /* --- Layout Grid (Colunas) --- */
             /* Posicionamento pelo grid-template-areas */
            #header-area { grid-area: header; text-align: center; margin-bottom: 5px; } /* Nova √°rea para t√≠tulo/subt√≠tulo */
            #col1-area { grid-area: col1; display: flex; flex-direction: column; } /* Usar flex para empilhar */
            #col2-area { grid-area: col2; }
            #col3-area { grid-area: col3; display: flex; flex-direction: column;} /* Log com flex */

            /* --- T√≠tulos --- */
            h1 {
                font-family: 'MedievalSharp', cursive; /* Fonte tem√°tica */
                color: #e8d0a8; /* Dourado mais claro */
                text-align: center;
                font-size: 2.2em; /* Maior */
                margin-bottom: 0px; /* Remover margem inferior */
                text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
                letter-spacing: 1px;
            }
            .subtitle {
                text-align: center;
                font-style: italic;
                margin-bottom: 15px; /* Menor espa√ßo */
                color: #a0907c; /* Cinza/Bege */
                font-size: 0.9em;
            }

            /* --- Descri√ß√£o da Cena --- */
            .scene-description {
                border-left: 5px solid #a06b3e; /* Borda marrom mais destacada */
                padding: 12px 18px;
                margin: 10px 0 15px 0; /* Ajustar margens */
                background-color: rgba(30, 25, 20, 0.7); /* Fundo escuro levemente transparente */
                color: #e0dacd; /* Texto mais claro */
                overflow-y: auto; /* Mudar para auto se quiser scroll s√≥ quando necess√°rio */
                max-height: 25vh; /* Aumentar altura m√°xima */
                border-radius: 0 3px 3px 0; /* Arredondar cantos direitos */
                font-size: 1.05em; /* Ligeiramente maior */
                line-height: 1.6;
                box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            }

            /* --- Status --- */
            .stats {
                display: flex;
                justify-content: space-around; /* Mais espa√ßo entre stats */
                background-color: rgba(100, 80, 60, 0.3); /* Fundo marrom mais sutil */
                padding: 12px;
                border-radius: 4px;
                margin: 0 0 15px 0; /* Margem inferior apenas */
                border: 1px solid #604a30;
                text-align: center; /* Centralizar texto dentro de .stat */
            }
            .stat div:first-child { /* Nome do stat */
                font-size: 0.85em;
                color: #c0b098; /* Cor mais clara para nome */
                margin-bottom: 3px;
            }
            .stat-value {
                font-weight: bold;
                font-size: 1.2em; /* Ligeiramente maior */
                color: #ffffff; /* Branco para destacar valor */
            }

            /* --- Escolhas --- */
            .choices {
                display: flex;
                flex-direction: column;
                gap: 8px; /* Menor espa√ßamento entre bot√µes */
                margin-top: auto; /* Empurra para baixo na col1 */
                padding-top: 15px; /* Espa√ßo acima dos bot√µes */
            }
            button { /* Estilo base para TODOS os bot√µes */
                font-family: 'MedievalSharp', cursive; /* Fonte Tem√°tica */
                background: linear-gradient(to bottom, #8b5a2b, #6a421a); /* Marrom */
                color: #f0e0d0;
                border: 1px solid #4a3010;
                border-radius: 3px; /* Menos arredondado */
                padding: 10px 15px;
                cursor: pointer;
                font-size: 1.1em; /* Maior */
                text-align: center;
                text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
                transition: all 0.15s ease;
                box-shadow: 0 2px 2px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
                margin: 0; /* Resetar margem padr√£o */
            }
            button:hover:not(:disabled) {
                background: linear-gradient(to bottom, #a06a3b, #8b5a2b);
                color: #ffffff;
                box-shadow: 0 3px 4px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            }
             button:active:not(:disabled) {
                 transform: translateY(1px);
                 box-shadow: 0 1px 1px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
             }
            button:disabled { /* Estilo para bot√£o desabilitado */
                background: linear-gradient(to bottom, #666, #444);
                color: #999;
                cursor: not-allowed;
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
                text-shadow: none;
            }

            /* --- Imagem --- */
            #image-container {
                 padding: 0; /* Remover padding se n√£o necess√°rio */
                 display: flex; /* Para centralizar imagem */
                 align-items: center;
                 justify-content: center;
                 background-color: #1a1612; /* Fundo bem escuro */
                 border-radius: 3px;
                 box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
                 /* Manter altura ou usar aspect-ratio */
                 /* height: 100%; */ /* Ocupa altura da c√©lula grid */
                 min-height: 300px; /* Garantir altura m√≠nima */
            }
            #image-container img {
                max-width: 100%;
                max-height: 100%; /* Imagem n√£o excede o container */
                object-fit: contain; /* Mant√©m propor√ß√£o */
                border: 2px solid #504030; /* Borda interna sutil */
                border-radius: 2px;
            }

            /* --- Invent√°rio --- */
            .inventory {
                margin: 0; /* Remover margem superior se stats j√° tem inferior */
                padding: 12px;
                background-color: rgba(100, 80, 60, 0.3); /* Igual stats */
                border-radius: 4px;
                border: 1px solid #604a30;
                flex-shrink: 0; /* N√£o encolher na coluna flex */
                 /* min-height: 100px; */ /* Altura m√≠nima opcional */
            }
            .inventory h3 {
                font-family: 'MedievalSharp', cursive; /* Fonte Tem√°tica */
                margin-top: 0;
                margin-bottom: 8px;
                color: #e0b070; /* Dourado p√°lido */
                font-size: 1.1em;
                border-bottom: 1px dashed #806a50;
                padding-bottom: 4px;
            }
            #inventory-items {
                 font-size: 0.95em;
                 color: #c0b0a0; /* Cor mais clara para itens */
                 list-style: none; /* Remove bullets se usar ul */
                 padding-left: 5px;
            }
            #inventory-items li { /* Se usar <li> */
                margin-bottom: 5px;
            }
            #inventory-items li::before {
                 color: #e0b070;
            }

            /* --- Dado --- */
            .dice-roll {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 15px 0; /* Reduzir margem */
                flex-shrink: 0; /* N√£o encolhe na coluna flex */
                gap: 15px; /* Espa√ßo entre dado e bot√£o */
            }
            .dice {
                width: 50px; height: 50px; /* Menor */
                background: linear-gradient(to bottom right, #ffffff, #e0e0e0); /* Gradiente sutil */
                border: 1px solid #555;
                border-radius: 6px;
                font-size: 1.8em; /* Maior */
                font-weight: bold;
                color: #333;
                box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
                 /* Font para o dado? */
            }
            .roll-button { /* J√° estilizado pelo 'button' gen√©rico */
                /* margin-left: 0; */ /* Remover margem se usar gap */
                 font-size: 1em; /* Tamanho do texto do bot√£o de rolar */
            }

            /* --- Log --- */
            .log { /* Agora √© #col3-area */
                 /* Remover estilos daqui, aplicados em #col3-area e #game-log */
             }
            #game-log {
                /* Estilos j√° aplicados acima */
                /* Garantir max-height para funcionar com flex */
                max-height: calc(95vh - 260px);
                overflow: auto;
            }

            /* --- Sele√ß√£o de Personagem --- */
            #character-select { /* Container geral */
                background-color: rgba(50, 40, 30, 0.8); /* Fundo para a sele√ß√£o */
                padding: 30px;
                border-radius: 5px;
                border: 1px solid #705a40;
                 grid-column: 1 / -1; /* Ocupa todas as colunas */
                 grid-row: 1 / -1; /* Ocupa todas as linhas (sobrep√µe o grid principal) */
                 z-index: 10; /* Fica por cima */
                 display: flex; /* Alterar para flex para melhor controle */
                 flex-direction: column;
                 align-items: center;
            }
            #character-select h2 {
                font-family: 'MedievalSharp', cursive;
                color: #e8d0a8;
                margin-bottom: 25px;
                font-size: 1.8em;
            }
            .character-select { /* O container dos cards */
                display: flex;
                gap: 20px; /* Maior espa√ßamento */
                justify-content: center;
                margin-bottom: 30px;
                flex-wrap: wrap; /* Permite quebrar linha se necess√°rio */
            }
            .character-card {
                border: 2px solid #907050; /* Borda marrom/dourada */
                border-radius: 4px;
                padding: 18px;
                text-align: center;
                cursor: pointer;
                width: 180px; /* Maior */
                background: linear-gradient(to bottom, #605040, #4a3a2a); /* Fundo do card */
                transition: all 0.2s ease-in-out;
                color: #c0b0a0; /* Cor base do texto */
                box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            }
             .character-card h3 {
                 font-family: 'MedievalSharp', cursive;
                 color: #f0e0c0; /* Cor do nome */
                 margin-top: 0; margin-bottom: 10px;
                 font-size: 1.2em;
             }
             .character-card p {
                 font-size: 0.9em;
                 line-height: 1.4;
                 margin-bottom: 8px;
             }
             .character-card p strong {
                 color: #f0d0b0; /* Cor dos stats */
             }
            .character-card:hover {
                transform: translateY(-4px) scale(1.03);
                box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
                border-color: #e0c090; /* Borda mais clara no hover */
            }
            .character-card.selected {
                border-color: #ffb030; /* Borda dourada brilhante */
                background: linear-gradient(to bottom, #7a6a5a, #605040);
                transform: scale(1.02); /* Leve aumento */
                 box-shadow: 0 4px 10px rgba(255, 180, 50, 0.3);
            }
             /* Bot√£o Iniciar Aventura */
             #character-select button {
                font-size: 1.2em; /* Bot√£o maior */
                padding: 12px 25px;
            }

            /* --- Mensagem Resultado (Check) --- */
            .result-message {
                padding: 10px 15px; /* Menor padding */
                margin: 10px auto; /* Centralizar e reduzir margem */
                border-radius: 4px;
                font-weight: bold;
                font-size: 1.1em; /* Ligeiramente maior */
                text-align: center;
                border: 1px solid; /* Adiciona borda */
                max-width: 80%; /* Limita largura */
                 box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
            .success { /* Sucesso verde */
                background-color: rgba(80, 150, 80, 0.3); /* Fundo verde mais sutil */
                color: #90ee90; /* Verde claro */
                border-color: #60a060;
            }
            .failure { /* Falha vermelha */
                background-color: rgba(150, 80, 80, 0.3); /* Fundo vermelho mais sutil */
                color: #f0a0a0; /* Vermelho claro */
                border-color: #a06060;
            }

            /* --- Loja Modal --- */
            .modal { /* Container que escurece */
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.75); /* Mais escuro */
                display: flex; justify-content: center; align-items: center;
                z-index: 100; /* Garantir que est√° por cima */
            }
            .modal-content { /* Janela da loja */
                background: linear-gradient(to bottom, #5a4a3a, #403020); /* Fundo da janela */
                border: 3px ridge #c5a880; /* Borda dourada tipo relevo */
                padding: 25px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
                font-family: 'Source Serif 4', serif;
                text-align: center;
                color: #e0dacd; /* Texto claro */
                border-radius: 5px;
                width: 90%; /* Mais responsivo */
                max-width: 450px; /* Limite */
            }
             .modal-content h2 { /* T√≠tulo da loja */
                 font-family: 'MedievalSharp', cursive;
                 color: #e8d0a8; /* Dourado */
                 margin-top: 0; margin-bottom: 15px;
                 font-size: 1.6em;
                 border-bottom: 1px solid #907050;
                 padding-bottom: 8px;
             }
             #player-gold { /* Ouro na loja */
                font-weight: bold;
                font-size: 1.1em;
                margin-bottom: 20px;
                color: #ffd700; /* Dourado brilhante */
            }
            .shop-items { /* Container dos itens */
                display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;
            }
            .shop-item { /* Bot√£o do item */
                /* Usar estilo base do 'button' */
                 /* Talvez um fundo ligeiramente diferente? */
                 background: linear-gradient(to bottom, #705030, #50381a);
             }
            #close-shop { /* Bot√£o fechar (j√° pega estilo base) */
                margin-top: 15px;
                 /* Fundo vermelho para fechar? */
                 /* background: linear-gradient(to bottom, #a04040, #802020); */
            }


            /* --- Bot√£o TTS --- */
            #tts-toggle-button {
                position: absolute;
                top: 8px; /* Alinhar com √°udio */
                left: calc(8px + 250px + 10px); /* Posicionar depois do √°udio (ajustar 250px se largura do audio mudar) */
                z-index: 20; /* Sobrepor elementos do jogo */
                font-size: 18px; /* √çcone maior */
                padding: 5px 8px;
                background: rgba(80, 70, 60, 0.7); /* Fundo sutil */
                color: #e0dacd;
                border: 1px solid #605040;
                border-radius: 50%; /* Bot√£o redondo */
                cursor: pointer;
                line-height: 1; /* Alinhar √≠cone verticalmente */
                opacity: 0.9;
                 transition: background-color 0.2s, opacity 0.2s;
             }
             #tts-toggle-button:hover {
                 background: rgba(100, 90, 80, 0.8);
                 opacity: 1;
             }

             /* --- Mensagem Info (Opcional) --- */
             #info { /* Ex: "Clique para iniciar" */
                position: fixed; /* Fixo na tela */
                bottom: 10px; /* Posi√ß√£o inferior */
                left: 50%;
                transform: translateX(-50%);
                 font-size: 0.9em;
                 color: #ccc;
                 background-color: rgba(0,0,0,0.6);
                 padding: 5px 10px;
                 border-radius: 3px;
                 z-index: 101; /* Acima de tudo */
             }


            /* Esconder elementos */
            .hidden { display: none !important; }
        </style>
    </head>
    <body>
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KM6SHZXP"
        height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <!-- End Google Tag Manager (noscript) -->
        
        <audio controls autoplay loop>
          <source src="audio/medieval-music.mp3" type="audio/mpeg" />
          Seu navegador n√£o suporta o elemento de √°udio.
        </audio>

        <!-- Adicionar bot√£o de TTS -->
        <button id="tts-toggle-button" style="position: absolute; top: 74px; left: 24px; z-index: 10; font-size: 16px; padding: 3px 6px;">
            üîä Narrador
        </button>
        <!-- Fim bot√£o TTS -->

        <div class="game-container">
            <!-- √Årea para T√≠tulo e Subt√≠tulo -->
            <div id="header-area">
                <h1>A Masmorra de Drakmor</h1>
                <p class="subtitle">Uma Aventura Simples de D&D</p>
            </div>

            <div id="character-select">
                <h2 style="text-align: center;">Escolha o Seu Personagem</h2>
                <div class="character-select">
                    <div class="character-card" data-class="warrior" onclick="selectCharacter('warrior')">
                        <h3>Guerreiro</h3>
                        <p>For√ßa e sa√∫de elevadas, habilidoso com armas</p>
                        <p>
                            <strong>FOR:</strong> 16 <strong>DES:</strong> 12 <br>
                            <strong>CON:</strong> 15 <strong>INT:</strong> 8
                        </p>
                    </div>
                    <div class="character-card" data-class="wizard" onclick="selectCharacter('wizard')">
                        <h3>Mago</h3>
                        <p>Mestre em magia arcana com feiti√ßos poderosos</p>
                        <p>
                            <strong>FOR:</strong> 8 <strong>DES:</strong> 14 <br>
                            <strong>CON:</strong> 10 <strong>INT:</strong> 17
                        </p>
                    </div>
                    <div class="character-card" data-class="rogue" onclick="selectCharacter('rogue')">
                        <h3>Ladino</h3>
                        <p>√Ågil e astuto, habilidoso em furtividade</p>
                        <p>
                            <strong>FOR:</strong> 10 <strong>DES:</strong> 17 <br>
                            <strong>CON:</strong> 12 <strong>INT:</strong> 14
                        </p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="startGame()">Come√ßar Aventura</button>
                </div>
            </div>

            <!-- Coluna 1 (Painel Esquerdo) -->
            <div id="col1-area">
                <div id="game-screen" class="hidden">
                    <div class="stats">
                        <div class="stat">
                            <div>‚ù§Ô∏è Vida</div>
                            <div class="stat-value" id="health">20</div>
                        </div>
                        <div class="stat">
                            <div>ü™ô Ouro</div>
                            <div class="stat-value" id="gold">5</div>
                        </div>
                        <div class="stat">
                            <div>üìà Experi√™ncia</div>
                            <div class="stat-value" id="xp">0</div>
                        </div>
                    </div>
                    <div class="scene-description" id="scene-text"></div>
                    <div id="dice-interaction-area">
                        <div id="dice-container" class="hidden dice-roll">
                            <div class="dice" id="dice">?</div>
                            <button id="dice-button" class="roll-button" onclick="rollDice()">üé≤ Rolar d20</button>
                        </div>
                        <div id="result-message" class="hidden result-message"></div>
                    </div>
                    <div class=choices id=choices></div>
                    <div class="inventory">
                        <h3>üéí Invent√°rio</h3>
                        <div id="inventory-items"> Nada ainda </div>
                    </div>
                    <div> <!-- Container para bot√£o da loja -->
                        <button id="open-shop">üõí Abrir Loja</button>
                    </div>
                </div>
            </div>
            <!-- Coluna 2 (Imagem) -->
            <div id="col2-area" class="hidden"> <!-- Classe hidden aqui para controlar visibilidade da coluna -->
                <div id="image-container"> <!-- Remover classe col2 daqui -->
                    <img id="image" src="./images/placeholder.png" alt="Cena Atual">
                </div>
            </div>
            <!-- Coluna 3 (Log) -->
            <div id="col3-area" class="hidden"> <!-- Classe hidden aqui -->
                <div id="log-container">
                    <h3 id="log-title">Di√°rio da Aventura</h3>
                    <div id="game-log"> <!-- Remover classe col3 e log daqui -->
                        <!-- Logs -->
                    </div>
                </div>
            </div>

        </div>
        <div id="shop-modal" class="modal hidden">
            <div class="modal-content">
                <h2>üè¶ Lojinha</h2>
                <p id="player-gold">ü™ô Ouro: 5</p>
                <div class="shop-items">
                    <button class="shop-item" data-item="Po√ß√£o de Vida" data-price="10">ü´ô Po√ß√£o de Vida - 10g</button>
                    <button class="shop-item" data-item="Espada" data-price="32">‚öîÔ∏è Espada - 32g</button>
                    <button class="shop-item" data-item="Machado" data-price="36">ü™ì Machado - 36g</button>
                    <button class="shop-item" data-item="Adaga" data-price="45">üíÄ Adaga de osso estranha - 45g</button>
                    <button class="shop-item" data-item="Escudo" data-price="31">üõ°Ô∏è Escudo - 31g</button>
                    <button class="shop-item" data-item="Corda" data-price="5">ü™¢ Corda - 5g</button>
                    <button class="shop-item" data-item="Tocha" data-price="2">üî¶ Tocha - 2g</button>
                </div>
                <button id="close-shop">Fechar</button>
            </div>
        </div>
        <div id="game-over" class="hidden">...</div>

        <!-- Mensagem Info -->
        <div id="info">Clique ou Pressione Tecla para Iniciar</div>

        <script>
            // Estado do jogo
            const gameState = {
                player: {
                    class: "",
                    health: 20,
                    maxHealth: 20,
                    gold: 5,
                    xp: 0,
                    inventory: [],
                    stats: {}
                },
                mem: {},
                currentScene: "start",
                lastScene: "start",
                currentEnemy: {
                    name: "Wolf",
                    ac: 12,
                    hp: 12,
                    max_hp: 12,
                    str: 10,
                    dex: 10,
                    con: 10,
                    bba: 1
                },
                log: [],
                pendingCheck: null,
                checkDifficulty: 10
            };
            // Atributos do personagem
            const characterStats = {
                warrior: {
                    str: 16,
                    dex: 12,
                    con: 15,
                    int: 8,
                    luck: 8,
                    bba: 2,
                    armor: 6
                },
                wizard: {
                    str: 8,
                    dex: 14,
                    con: 10,
                    int: 17,
                    luck: 12,
                    bba: 1,
                    armor: 2
                },
                rogue: {
                    str: 10,
                    dex: 17,
                    con: 12,
                    int: 14,
                    luck: 10,
                    bba: 1,
                    armor: 4
                }
            };

            let currentTypewriterInterval = null;
            let skipTyping = false;

            var choicesElement = document.getElementById('choices');

            // --- Fase 2: TTS Variables ---
            let ttsEnabled = true; // Controle global para ativar/desativar TTS
            let synth = window.speechSynthesis; // Acesso √† API de fala
            let voices = []; // Array para guardar as vozes dispon√≠veis
            let selectedVoice = null; // Para guardar a voz pt-BR preferida
            let utterance = null; // Para guardar a inst√¢ncia da fala atual
            // Flag para indicar se a API de fala foi "desbloqueada" pela intera√ß√£o do usu√°rio
            let speechApiUnlocked = false;

            // Cenas do jogo
            const scenes = {
                start: {
                    text: "Voc√™ est√° na entrada da antiga Masmorra de Drakmor. Degraus de pedra esculpida levam para a escurid√£o. Lendas falam de tesouros dentro, mas tamb√©m de armadilhas mortais e monstros tem√≠veis. O ar est√° frio contra sua pele enquanto voc√™ observa a penumbra.",
                    choices: [{
                        text: "Entrar na masmorra",
                        nextScene: "corridor"
                    }, {
                        text: "Inspecionar a entrada para armadilhas",
                        nextScene: "entrance_inspection"
                    }, {
                        text: "Verificar seus suprimentos antes de entrar",
                        nextScene: "check_supplies"
                    }, {
                        text: "Comprar suprimentos antes de come√ßar a jornada",
                        nextScene: "buy_supplies"
                    }]
                },
                buy_supplies: {
                    text: "Voc√™ est√° na entrada da antiga Masmorra de Drakmor. Degraus de pedra esculpida levam para a escurid√£o. Lendas falam de tesouros dentro, mas tamb√©m de armadilhas mortais e monstros tem√≠veis. O ar est√° frio contra sua pele enquanto voc√™ observa a penumbra.",
                    choices: [{
                        text: "Entrar na masmorra",
                        nextScene: "corridor"
                    }, {
                        text: "Inspecionar a entrada para armadilhas",
                        nextScene: "entrance_inspection"
                    }, {
                        text: "Verificar seus suprimentos antes de entrar",
                        nextScene: "check_supplies"
                    }],
                    onEnter: function() {
                        playerGoldElement.textContent = `Ouro: ${gameState.player.gold}`;
                        shopModal.classList.remove('hidden');
                    }
                },
                entrance_inspection: {
                    text: "Voc√™ examina cuidadosamente a entrada. A alvenaria √© antiga, mas s√≥lida. Voc√™ nota algumas marcas de arranh√µes perto do ch√£o - talvez de criaturas arrastando algo... ou algu√©m. N√£o parece haver nenhuma armadilha na entrada em si.",
                    choices: [{
                        text: "Entrar na masmorra",
                        nextScene: "corridor"
                    }, {
                        text: "Verificar seus suprimentos antes de entrar",
                        nextScene: "check_supplies"
                    }]
                },
                check_supplies: {
                    text: "Voc√™ faz um balan√ßo de seus suprimentos escassos. Um pequeno cantil de √°gua, um pouco de carne seca, um isqueiro para iniciar fogo e sua arma confi√°vel. Voc√™ espera que seja o suficiente para o que quer que esteja esperando abaixo.",
                    choices: [{
                        text: "Entrar na masmorra",
                        nextScene: "corridor"
                    }],
                    onEnter: function() {
                        addToInventory("Cantil de √Ågua");
                        addToInventory("Carne Seca");
                        addToInventory("Isqueiro");
                    }
                },
                corridor: {
                    text: "O corredor se estende √† sua frente, mal iluminado por fungos fosforescentes nas paredes. O ar √© √∫mido e bolorento. Depois de caminhar por alguns minutos, voc√™ chega a uma bifurca√ß√£o no caminho.",
                    choices: [{
                        text: "Pegar o caminho da esquerda",
                        nextScene: "goblin_encounter"
                    }, {
                        text: "Pegar o caminho da direita",
                        nextScene: "treasure_room"
                    }]
                },
                goblin_encounter: {
                    text: "Ao virar uma esquina, voc√™ fica cara a cara com um goblin rosnando! Ele √© pequeno, mas cruel, empunhando um punhal enferrujado e vestindo uma armadura de couro esfarrapada. Ele sibila e se prepara para atacar!",
                    choices: [{
                        text: "Lutar contra o goblin",
                        nextScene: "goblin_fight",
                        requiresCheck: true,
                        checkType: "combat"
                    }, {
                        text: "Tentar passar furtivamente",
                        nextScene: "goblin_stealth",
                        requiresCheck: true,
                        checkType: "stealth"
                    }, {
                        text: "Tentar argumentar com ele",
                        nextScene: "goblin_talk",
                        requiresCheck: true,
                        checkType: "persuasion"
                    }],
                    onEnter: function() {
                        gameState.mem.nextSceneSuccess = 'goblin_fight_success';
                        gameState.currentEnemy = {
                            name: "Goblin",
                            ac: 10,
                            hp: 12,
                            max_hp: 12,
                            str: 10,
                            dex: 10,
                            con: 10,
                            bba: 1
                        }
                    }
                },
                goblin_stealth: {
                    text: "Voc√™ passa pelo goblin sem problemas!",
                    choices: [{
                        text: "Continuar pelo corredor",
                        nextScene: "dark_chamber"
                    }, {
                        text: "Voltar e lutar contra o goblin",
                        nextScene: "goblin_fight",
                        requiresCheck: true,
                        checkType: "combat"
                    }],
                    onEnter: function() {
                        gameState.mem.nextSceneSuccess = 'goblin_fight_success';
                        gameState.currentEnemy = {
                          name: "Goblin",
                          ac: 10,
                          hp: 12,
                          max_hp: 12,
                          str: 10,
                          dex: 10,
                          con: 10,
                          bba: 1
                      }
                    }
                },
                goblin_fight_success: {
                    text: "Voc√™ se mant√©m firme e se defende dos ataques do goblin. Ap√≥s uma luta breve, mas intensa, o goblin tomba sangrando dando seu √∫ltimo suspiro.",
                    choices: [{
                        text: "Continuar pelo corredor",
                        nextScene: "dark_chamber"
                    }],
                    onEnter: function() {
                        changeXP(25);
                    }
                },
                goblin_fight_failure: {
                    text: "Voc√™ se n√£o resiste a f√∫ria insana no globin e tomba sob sua adaga enferrujada. Voc√™ morreu.",
                    choices: [],
                    onEnter: function() {
                        addToLog("‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è Voc√™ morreu para o goblin ‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è");
                    }
                },
                treasure_room: {
                    text: "O ar fica pesado com o cheiro de madeira envelhecida e metal polido quando voc√™ abre a porta rangendo. Diante de voc√™, uma c√¢mara brilha com a luz quente de mil reflexos dourados. Pilhas de moedas caem em cascata como cachoeiras congeladas, suas superf√≠cies captando o brilho de antigas lanternas encantadas. No centro, um pedestal sustenta um √∫nico ba√∫ ornamentado, sua superf√≠cie gravada com runas que pulsam fracamente com energia arcana.",
                    choices: [{
                        text: "Pegar todos os tesouros!!!",
                        nextScene: "getting_trasure"
                    }],
                    onEnter: function() {
                        addToInventory("Cristais da Caverna");
                        addToInventory("Braceletes de ouro");
                        changeGold(800);
                    }
                },
                getting_trasure: {
                    text: "Depois de pegar todas as coisas e colocar em sua mochila, um rosnado baixo e gutural ressoa atr√°s de voc√™, enviando um arrepio pela sua espinha. Voc√™ se vira lentamente, sua respira√ß√£o presa enquanto um lobo enorme emerge das sombras, com o pelo eri√ßado e os dentes √† mostra em um rosnado. Seus olhos amarelos penetrantes se fixam nos seus, m√∫sculos tensos como molas, prontos para atacar ao menor movimento.",
                    choices: [{
                        text: "Tentar acalmar o lobo",
                        nextScene: "wolf_calm",
                        requiresCheck: true,
                        checkType: "luck"
                    }, {
                        text: "Lutar contra o lobo",
                        nextScene: "wolf_fight",
                        requiresCheck: true,
                        checkType: "combat"
                    }],
                    onEnter: function() {
                        gameState.mem.nextSceneSuccess = 'wolf_fight_success';
                        gameState.currentEnemy = {
                            name: "Wolf",
                            ac: 14,
                            hp: 10,
                            max_hp: 10,
                            str: 12,
                            dex: 8,
                            con: 10,
                            bba: 1
                        }
                    }
                },
                wolf_fight_success: {
                    text: "O lobo n√£o aguenta os ferimentos e tomba perdendo a consci√™ncia aos seus p√©s.",
                    choices: [{
                        text: "Fugir de volta para a c√¢mara",
                        nextScene: "dark_chamber"
                    }],
                    onEnter: function() {
                      changeXP(25);
                    }
                },
                wolf_fight_failure: {
                    text: "O lobo da caverna √© um inimigo formid√°vel. Apesar de seus melhores esfor√ßos, ele o domina, infligindo feridas profundas. Voc√™ mal consegue escapar com vida, recuando pelo caminho que veio.",
                    choices: [{
                        text: "Fugir de volta para a c√¢mara",
                        nextScene: "dark_chamber"
                    }]
                },
                wolf_calm_success: {
                    text: "Voc√™ estende a m√£o lentamente, falando em tons suaves. O lobo, surpreso com sua falta de agress√£o, hesita. Voc√™ nota o espinho em sua pata e se oferece para ajudar. Cautelosamente, ele permite que voc√™ remova o espinho. O al√≠vio toma conta do lobo, e ele lambe sua m√£o em gratid√£o antes de recuar para o interior da caverna.",
                    choices: [{
                        text: "Atravessar o riacho agora",
                        nextScene: "cavern_crossing",
                        requiresCheck: true,
                        checkType: "dex"
                    }, {
                        text: "Retornar para a c√¢mara",
                        nextScene: "dark_chamber"
                    }],
                    onEnter: function() {
                        changeXP(20);
                    }
                },
                wolf_calm_failure: {
                    text: "O lobo n√£o responde √†s suas tentativas de acalm√°-lo. Ele permanece cauteloso e hostil, rosnando profundamente. Parece que ele n√£o est√° disposto a confiar em voc√™.",
                    choices: [{
                        text: "Lutar contra o lobo",
                        nextScene: "wolf_fight",
                        requiresCheck: true,
                        checkType: "combat"
                    }, {
                        text: "Recuar lentamente em dire√ß√£o a caverna sem desviar o olhar do lobo",
                        nextScene: "cavern",
                        requiresCheck: true,
                        checkType: "luck"
                    }],
                    onEnter: function() {
                        gameState.currentEnemy = {
                            name: "Wolf",
                            ac: 14,
                            hp: 10,
                            max_hp: 10,
                            str: 12,
                            dex: 8,
                            con: 10,
                            bba: 1
                        }
                    }
                },
                dark_chamber: {
                    text: "Voc√™ continua descendo a passagem, caminhando lentamente por 20 metros mais ou menos e √† sua frente voc√™ tem uma c√¢mara escura. L√° dentro n√£o tem nada de interessante, apenas 2 portas de madeira antigas √† sua frente",
                    choices: [{
                        text: "Porta esquerda",
                        nextScene: "cavern"
                    }, {
                        text: "Porta direita",
                        nextScene: "cavern"
                    }]
                },
                cavern: {
                    text: "Voc√™ caminha por um tempo at√© a entrada de um corredor muito escuro. Na verdade, esse maldito corredor est√° mais escuro que a cueca do Batman! N√£o lhe parece seguro seguir sem saber o que tem ali...",
                    choices: [{
                        text: "V√° em frente e atravesse a caverna",
                        nextScene: "cavern_crossing",
                        requiresCheck: true,
                        checkType: "dex"
                    }, {
                        text: "Voltar para a c√¢mara escura",
                        nextScene: "dark_chamber"
                    }],
                    onEnter: function() {
                        if (gameState.player.inventory.includes("Tocha")) {
                            scenes["cavern"].choices.push({
                                text: "Acender uma tocha!",
                                nextScene: "cavern_crossing_success"
                            })
                            addChoiceInCurrentScene(scenes["cavern"]);
                            addToLog("üïØÔ∏è Valeu a pena comprar uma tocha!")
                        }
                    }
                },
                cavern_crossing_success: {
                    text: "Voc√™ navega cuidadosamente pelas pedras escorregadias e pela correnteza r√°pida do riacho subterr√¢neo. Voc√™ chega ao outro lado, levemente molhado, mas ileso. Uma passagem estreita continua adiante a partir daqui.",
                    choices: [{
                        text: "Continue na passagem",
                        nextScene: "crystal_cave"
                    }],
                    "onEnter": function() {
                        changeXP(10);
                    }
                },
                cavern_crossing_failure: {
                    text: "Voc√™ erra um passo e escorrega nas pedras molhadas, mergulhando no riacho frio! Voc√™ consegue chegar ao outro lado, encharcado e tremendo. A passagem √† frente parece pouco convidativa, mas voltar √© t√£o frio quanto.",
                    choices: [{
                        text: "Continue na passagem, apesar de estar molhado",
                        nextScene: "crystal_cave"
                    }, {
                        text: "Retorne √† c√¢mara, pingando √°gua",
                        nextScene: "dark_chamber"
                    }],
                    "onEnter": function() {
                        changeHealth(-2); // Penalidade menor de sa√∫de por √°gua fria
                    }
                },
                crystal_cave: {
                    text: "A passagem estreita se abre para uma caverna de cristal de tirar o f√¥lego. Paredes, teto e ch√£o s√£o cobertos por cristais brilhantes de v√°rios tamanhos e cores, refletindo sua luz em um show deslumbrante. Mais adentro, voc√™ v√™ um caminho fraco serpenteando pelos cristais.",
                    choices: [{
                        text: "Siga o caminho mais fundo",
                        nextScene: "crystal_path"
                    }, {
                        text: "Examine os cristais mais de perto",
                        nextScene: "crystal_examine"
                    }, {
                        text: "Retorne ao riacho da caverna",
                        nextScene: "cavern_crossing"
                    }]
                },
                crystal_path: {
                    text: "Voc√™ segue o caminho sinuoso, os cristais se tornando mais densos e magn√≠ficos. O caminho leva a uma abertura maior - voc√™ sente que est√° se aproximando de algo significativo.",
                    choices: [{
                        text: "Prossiga com cautela",
                        nextScene: "crystal_chamber"
                    }]
                },
                crystal_examine: {
                    text: "Voc√™ tira um momento para examinar os cristais mais de perto. Eles s√£o de qualidade excepcional, alguns irradiando uma leve luz interior. Voc√™ provavelmente poderia arrancar alguns...",
                    choices: [{
                        text: "Tente coletar alguns cristais",
                        nextScene: "crystal_collect",
                        requiresCheck: true,
                        checkType: "dex"
                    }, {
                        text: "Siga o caminho mais fundo",
                        nextScene: "crystal_path"
                    }, {
                        text: "Retorne ao riacho da caverna",
                        nextScene: "cavern_crossing"
                    }]
                },
                crystal_collect_success: {
                    text: "Trabalhando cuidadosamente para soltar alguns dos cristais mais acess√≠veis, voc√™ consegue coletar um punhado de belas joias. Elas s√£o frias ao toque e podem valer uma boa grana.",
                    choices: [{
                        text: "Continue mais fundo na caverna",
                        nextScene: "crystal_path"
                    }],
                    "onEnter": function() {
                        addToInventory("Cristais da Caverna");
                        changeGold(8);
                    }
                },
                crystal_collect_failure: {
                    text: "Ao tentar arrancar um cristal, voc√™ desaloja um peda√ßo maior de rocha. Ele cai, por pouco n√£o atingindo seu p√© e fazendo um barulho alto pela caverna. O barulho acaba atraindo uma aranha gigante.",
                    choices: [{
                        text: "Lutar contra a aranha",
                        nextScene: "spider_fight",
                        requiresCheck: true,
                        checkType: "combat"
                    }],
                    onEnter: function() {
                        gameState.currentEnemy = {
                            name: "Spider",
                            ac: 13,
                            hp: 16,
                            max_hp: 16,
                            str: 12,
                            dex: 8,
                            con: 10,
                            bba: 2
                        }
                    }
                },
                spider_fight_success: {
                    text: "A aranha cai morta perante a f√∫ria de seus golpes. √â hora de seguir em frente.",
                    choices: [{
                        text: "√â hora de seguir em frente",
                        nextScene: "crystal_path"
                    }],
                    onEnter: function() {
                      changeXP(50);
                    }
                },
                spider_fight_failure: {
                    text: "A aranha quase te mata mas no √∫ltimo golpe ela escuta um barulho alto e foge rapidamente para a escurid√£o da caverna.",
                    choices: [{
                        text: "Seguir adiante",
                        nextScene: "crystal_path"
                    }]
                },
                crystal_chamber: {
                    text: "O caminho se abre para uma grande c√¢mara de cristal. Enormes forma√ß√µes de pilares de cristal se erguem do ch√£o e pendem do teto, criando uma floresta de luz sobrenatural. No centro, em um estrado elevado de cristal puro, voc√™ v√™ um objeto cintilante. Este deve ser um tesouro significativo!",
                    choices: [{
                        text: "Aproxime-se do estrado",
                        nextScene: "crystal_treasure_approach"
                    }, {
                        text: "Procure outras sa√≠das",
                        nextScene: "crystal_cave_exits"
                    }]
                },
                crystal_cave_exits: {
                    text: "Voc√™ examina as paredes da c√¢mara de cristal. Al√©m do caminho de onde voc√™ veio, voc√™ v√™ uma abertura estreita perto do ch√£o, quase escondida atr√°s de um aglomerado de cristais maiores.",
                    choices: [{
                        text: "Investigue a abertura estreita",
                        nextScene: "secret_passage_entrance"
                    }, {
                        text: "Vasculhar aglomerado de cristais",
                        nextScene: "crystal_treasure_approach"
                    }]
                },
                crystal_cave_exits_alternative: {
                    text: "Voc√™ examina as paredes da c√¢mara de cristal. Al√©m do caminho de onde voc√™ veio, voc√™ v√™ uma abertura estreita perto do ch√£o, quase escondida atr√°s de um aglomerado de cristais maiores.",
                    choices: [{
                        text: "Investigue a abertura estreita",
                        nextScene: "secret_passage_entrance"
                    }]
                },
                crystal_treasure_approach: {
                    text: "Voc√™ vasculha o aglomerado de cristais e um tent√°culo roxo enorme e gosmento sai dentro do monte de cristais e agarra-lhe repentinamente! uma aura fantasmag√≥rica surge junto com o tent√°culo com vozes do al√©m implorando para que voc√™ os libertem",
                    choices: [{
                        text: "Arrebentar o tentaculo na for√ßa bruta",
                        nextScene: "destroy_tentacle"
                    }, {
                        text: "Cortar o tentaculo",
                        nextScene: "cutting_tentacle"
                    }, {
                        text: "Cortar seu pr√≥prio bra√ßo para escapar",
                        nextScene: "cutting_arm"
                    }, {
                        text: "Colocar o obejto mais pr√≥ximo no tentaculo pra ver o que acontece",
                        nextScene: "lost_money_tentacle"
                    }]
                },
                lost_money_tentacle: {
                    text: "O objecto mais pr√≥ximo √© sua pr√≥pria mochila e √© ela que voc√™ coloca no tent√°culo para ver se ela te solta",
                    choices: [{
                        text: "Remover o tent√°culo",
                        nextScene: "remove_tentacle",
                        requiresCheck: true,
                        checkType: "luck"
                    }],
                    onEnter: function() {
                        if (gameState.player.inventory.includes("Cristais da Caverna")) {
                            gameState.checkDifficulty = 4
                        } else {
                            if (haveMoney(100)) {
                                gameState.checkDifficulty = 4
                            } else {
                                gameState.checkDifficulty = 14
                            }
                        }
                    }
                },
                remove_tentacle_success: {
                    text: "A mochila pesada chama a aten√ß√£o do tent√°culo fazendo-o lagar seu bra√ßo.",
                    choices: [{
                        text: "Se afastar dos tent√°culos",
                        nextScene: "tentacle_result_success"
                    }],
                    onEnter: function() {
                      changeXP(50)
                    }
                },
                destroy_tentacle: {
                  text: "Voc√™ segura firme o tent√°culo e o puxa com toda a sua for√ßa na esperan√ßa de arrebent√°-lo brutalmente.",
                  choices: [{
                      text: "E agora?",
                      nextScene: "tentacle_result",
                      requiresCheck: true,
                      checkType: "str"
                  }],
                  onEnter: function() {
                    gameState.checkDifficulty = 20
                  }
                },
                cutting_tentacle: {
                  text: "Voc√™ pega sua arma rapidamente sem pensar duas vezes e acerta o tent√°culo na tentativa de corta-lo.",
                  choices: [{
                      text: "E agora?",
                      nextScene: "tentacle_result",
                      requiresCheck: true,
                      checkType: "str"
                  }],
                  onEnter: function() {
                    gameState.checkDifficulty = 16
                  }
                },
                cutting_arm: {
                  text: "Voc√™ n√£o pensa duas vezes em cortar seu pr√≥prio bra√ßo na tentativa de se salvar, pois percebe rapidamente que o tent√°culo √© absurdamente forte e resistente e tentar golpe√°-lo seria perda de tempo e voc√™ certamente morreria tentando.",
                  choices : [{
                      text: "E agora?",
                      nextScene: "tentacle_result",
                      requiresCheck: true,
                      checkType: "str"
                  }],
                  "onEnter": function() {
                      gameState.checkDifficulty = 6
                      changeHealth(-13)
                  }
                },
                tentacle_result_success: {
                  text: "Voc√™ conseuiu escapar da morte certa por muito pouco. Voc√™ junta sua mochila com as coisas que sobraram e segue adiante rapidamente.",
                  choices: [{
                    text: "Investigue a abertura estreita",
                    nextScene: "secret_passage_entrance"
                  }],
                  "onEnter": function() {
                      changeXP(20)
                  }
                },
                tentacle_result_failure: {
                  text: "Voc√™ subestimou a for√ßa do tent√°culo e ele te puxa pra dentro do aglomerado de cristais onde outros tent√°culos te agarram e espremem com for√ßa!",
                  choices: [{
                    text: "Gritar por socorro",
                    nextScene: "death"
                  }]
                },
                secret_passage_entrance: {
                    text: "A abertura estreita parece levar a um t√∫nel toscamente esculpido. √â escuro e apertado, mas pode oferecer um caminho alternativo... ou para outra parte da masmorra.",
                    choices: [{
                        text: "Aventure-se na passagem secreta",
                        nextScene: "secret_passage"
                    }, {
                        text: "Retorne ao centro da c√¢mara de cristal",
                        nextScene: "crystal_chamber"
                    }]
                },
                secret_passage: {
                    text: "A passagem secreta √© realmente apertada e empoeirada, mas parece inclinar para baixo. Depois de algum arrastar pela escurid√£o, o t√∫nel come√ßa a se alargar e voc√™ ouve o som distante de √°gua pingando.",
                    choices: [{
                        text: "Continue mais fundo na passagem",
                        nextScene: "underground_lake"
                    }, {
                        text: "Retorne ao centro da c√¢mara de cristal",
                        nextScene: "crystal_chamber"
                    }]
                },
                underground_lake: {
                    text: "A passagem se abre para uma grande caverna dominada por um lago subterr√¢neo. A √°gua √© escura e parada, refletindo a luz fraca do musgo fosforescente no teto. Uma jangada de madeira de apar√™ncia inst√°vel est√° amarrada a uma rocha perto da costa.",
                    choices: [{
                        text: "Pegue a jangada para atravessar o lago",
                        nextScene: "lake_raft",
                        requiresCheck: true,
                        checkType: "dex"
                    }, {
                        text: "Procure outro caminho ao redor do lago",
                        nextScene: "lake_search"
                    }, {
                        text: "Retorne √† c√¢mara de cristal",
                        nextScene: "crystal_chamber"
                    }]
                },
                lake_raft_success: {
                    text: "Equilibrando-se cuidadosamente na velha jangada, voc√™ usa uma vara improvisada para navegar pelo lago escuro. √â uma jornada lenta e prec√°ria, mas voc√™ chega √† costa oposta em seguran√ßa. A entrada de um t√∫nel escuro espera.",
                    choices: [{
                        text: "Entre no t√∫nel",
                        nextScene: "final_chamber_entrance"
                    }],
                    "onEnter": function() {
                        changeXP(20);
                    }
                },
                lake_raft_failure: {
                    text: "A jangada est√° mais podre do que parecia. No meio do lago, ela come√ßa a se desfazer! Voc√™ mergulha na √°gua gelada, lutando para nadar at√© a costa oposta. Voc√™ consegue, mas est√° congelando e perdeu alguns suprimentos.",
                    choices: [{
                        text: "Continue no t√∫nel, tremendo",
                        nextScene: "final_chamber_entrance"
                    }],
                    "onEnter": function() {
                        changeHealth(-5);
                        if (gameState.player.inventory.includes('Isqueiro')) {
                            removeFromInventory("Isqueiro");
                        }
                        if (gameState.player.inventory.includes('Carne Seca')) {
                            removeFromInventory("Carne Seca");
                        }
                        
                    }
                },
                lake_search: {
                    text: "Voc√™ procura na beira do lago subterr√¢neo por outro caminho. Depois de algum tempo, voc√™ encontra uma sali√™ncia estreita ao longo da parede da caverna, logo acima do n√≠vel da √°gua. Parece trai√ßoeiro.",
                    choices: [{
                        text: "Tente atravessar usando a sali√™ncia",
                        nextScene: "lake_ledge_cross",
                        requiresCheck: true,
                        checkType: "dex"
                    }, {
                        text: "Volte e pegue a jangada",
                        nextScene: "lake_raft",
                        requiresCheck: true,
                        checkType: "dex"
                    }]
                },
                lake_ledge_cross_success: {
                    text: "Com passos cuidadosos e pressionado contra a parede √∫mida da caverna, voc√™ segue pela sali√™ncia estreita. √â uma caminhada estressante, mas voc√™ chega ao outro lado com sucesso, evitando a √°gua fria completamente. H√° duas op√ß√µes a seguir:",
                    choices: [{
                        text: "Entre no t√∫nel √† frente",
                        nextScene: "final_chamber_entrance"
                    }, {
                        text: "Des√ßa pelas escadas em espiral a sua esquerda",
                        nextScene: "crypt"
                    }],
                    "onEnter": function() {
                        changeXP(25);
                    }
                },
                lake_ledge_cross_failure: {
                    text: "A sali√™ncia √© muito estreita e escorregadia. No meio do caminho, seu p√© escorrega e voc√™ perde o equil√≠brio, caindo no lago gelado abaixo! Voc√™ nada at√© a costa oposta, encharcado e derrotado.",
                    choices: [{
                        text: "Continue no t√∫nel, tremendo",
                        nextScene: "final_chamber_entrance"
                    }, {
                        text: "Retorne √† c√¢mara de cristal, admitindo a derrota",
                        nextScene: "crystal_chamber"
                    }],
                    "onEnter": function() {
                        changeHealth(-6);
                    }
                },
                final_chamber_entrance: {
                    text: "O t√∫nel leva a uma c√¢mara final e imponente. Tochas tremulam em arandelas de parede, lan√ßando sombras dan√ßantes pelas paredes ricamente decoradas. No centro da c√¢mara, no topo de um estrado elevado, est√° um grande cofre ornamentado. Este deve ser o lend√°rio tesouro de Drakmor!",
                    choices: [{
                        text: "Aproxime-se do cofre",
                        nextScene: "final_treasure_approach_careful_failure"
                    }, {
                        text: "Procure armadilhas na c√¢mara primeiro",
                        nextScene: "final_chamber_search",
                        requiresCheck: true,
                        checkType: "int"
                    }]
                },
                final_chamber_search_success: {
                    text: "Seus olhos atentos notam linhas fracas gravadas no ch√£o ao redor do estrado e pequenos buracos nas paredes perto do cofre. Mecanismos de armadilha, provavelmente placas de press√£o e lan√ßadores de dardos. Voc√™ anota cuidadosamente suas localiza√ß√µes.",
                    choices: [{
                        text: "Aproxime-se cuidadosamente do cofre",
                        nextScene: "final_treasure_approach_careful",
                        requiresCheck: true,
                        checkType: "dex"
                    }],
                    "onEnter": function() {
                        changeXP(20);
                    }
                },
                final_chamber_search_failure: {
                    text: "Voc√™ procura por armadilhas, mas a c√¢mara est√° cheia de sombras e sua luz n√£o √© forte o suficiente para penetr√°-las totalmente. Voc√™ n√£o pode ter certeza se h√° alguma armadilha ou n√£o.",
                    choices: [{
                        text: "Aproxime-se do cofre com cautela mesmo assim",
                        nextScene: "final_treasure_approach"
                    }, {
                        text: "Usar o isqueiro",
                        nextScene: "final_treasure_approach_careful_success"
                    }]
                },
                final_chamber_search_failure_no_isqueiro: {
                    text: "Voc√™ procura por armadilhas, mas a c√¢mara est√° cheia de sombras e sua luz n√£o √© forte o suficiente para penetr√°-las totalmente. Voc√™ n√£o pode ter certeza se h√° alguma armadilha ou n√£o.",
                    choices: [{
                        text: "Aproxime-se do cofre com cautela mesmo assim",
                        nextScene: "final_treasure_approach"
                    }]
                },
                final_treasure_approach: {
                    text: "Respirando fundo, voc√™ decide se aproximar do cofre diretamente. Voc√™ caminha em dire√ß√£o ao estrado, seus sentidos em alerta m√°ximo...",
                    choices: [{
                            text: "Continue at√© o cofre",
                            nextScene: "final_treasure_open",
                            requiresCheck: true,
                            checkType: "luck"
                        } // Teste de sorte, pois voc√™ est√° indo √†s cegas para as armadilhas.
                    ]
                },
                final_treasure_approach_careful_success: {
                    text: "Usando seu conhecimento da localiza√ß√£o das armadilhas, voc√™ cuidadosamente contorna as placas de press√£o e evita acionar os lan√ßadores de dardos. Voc√™ chega ao estrado e ao cofre em seguran√ßa. Sua cautela valeu a pena!",
                    choices: [{
                        text: "Abra o cofre",
                        nextScene: "final_treasure_open_success"
                    }],
                    "onEnter": function() {
                        changeXP(30);
                        if (!gameState.player.inventory.includes('Isqueiro')) {
                            alert("‚ÅâÔ∏è Ops, parece que vc n√£o tem mais o Isqueiro. Voltando para a cena anterior.");
                            setTimeout(() => {
                                loadScene('final_chamber_search_failure_no_isqueiro')
                            }, 300);

                        }
                    }
                },
                final_treasure_approach_careful_failure: {
                    text: "Apesar de seus passos cuidadosos, voc√™ calcula mal a posi√ß√£o de uma placa de press√£o. H√° um clique e uma saraivada de dardos √© disparada em sua dire√ß√£o de aberturas escondidas nas paredes! Voc√™ √© atingido, mas consegue cambalear at√© o estrado que acaba quebrando e fazendo-o cair. Voc√™ mergulha na escurid√£o, caindo com for√ßa em um po√ßo escondido.",
                    choices: [{
                        text: "?",
                        nextScene: "crypt"
                    }],
                    "onEnter": function() {
                        changeHealth(-5);
                    }
                },
                final_treasure_open_success: {
                    text: "Com um baque pesado, a tampa do cofre se abre! Dentro, aninhada em almofadas de veludo, est√° uma magn√≠fica espada de joias. Ela irradia poder e magia ancestral. Moedas de ouro e joias se espalham ao redor dela, mais riqueza do que voc√™ jamais sonhou!",
                    choices: [{
                        text: "Reivindique o tesouro!",
                        nextScene: "last_fight"
                    }],
                    "onEnter": function() {
                        addToInventory("Espada Joia de Drakmor");
                        changeGold(5000);
                        changeXP(50);
                        gameState.player.maxHealth += 40;
                        gameState.player.health = gameState.player.maxHealth;
                        gameState.player.stats.str += 4;
                        gameState.player.stats.bba += 2;
                        addToLog("üíç üëë üíµ üí∞ ü™ô üíé");
                    }
                },
                final_treasure_open_failure: {
                    text: "Ao alcan√ßar o cofre, o estrado abaixo de voc√™ cede! Voc√™ mergulha na escurid√£o, caindo com for√ßa em um po√ßo escondido. O cofre e o tesouro permanecem tentadoramente fora de alcance acima de voc√™.",
                    choices: [{
                        text: "Tente sair do po√ßo",
                        nextScene: "pit_escape",
                        requiresCheck: true,
                        checkType: "str"
                    }, {
                        text: "Aceite a derrota e tente encontrar outra sa√≠da",
                        nextScene: "crypt"
                    }],
                    onEnter: function() {
                        if (!gameState.player.inventory.includes("Corda")) {
                            scenes["final_treasure_open_failure"].choices.push({
                                text: "Usar a corda para subir",
                                nextScene: "pit_escape"
                            })
                            addChoiceInCurrentScene(scenes["final_treasure_open_failure"]);
                            addToLog("ü™¢ Valeu a pena comprar uma corda!");
                        }
                    }
                },
                pit_escape_success: {
                    text: "Usando toda a sua for√ßa, voc√™ encontra pontos de apoio nas paredes do po√ßo e consegue subir de volta para o ch√£o da c√¢mara, machucado e ferido, mas determinado.",
                    choices: [{
                        text: "Tente abrir o cofre novamente",
                        nextScene: "final_treasure_open"
                    }, {
                        text: "Talvez este tesouro n√£o valha a pena. Recue.",
                        nextScene: "dark_chamber"
                    }],
                    "onEnter": function() {
                        changeHealth(-3); // Les√£o por cair no po√ßo
                    }
                },
                pit_escape_failure: {
                    text: "As paredes do po√ßo s√£o muito lisas e √≠ngremes para escalar. Voc√™ luta, mas n√£o encontra apoio. Voc√™ est√° preso, sem como alcan√ßar o tesouro acima.",
                    choices: [{
                        text: "Pe√ßa ajuda (se algu√©m puder ouvi-lo...)",
                        nextScene: "death"
                    }, {
                        text: "Procure outra sa√≠da no po√ßo",
                        nextScene: "death"
                    }],
                    "onEnter": function() {
                        changeHealth(-2); // Ferimentos leves por tentativa de fuga fracassada
                    }
                },
                crypt: {
                    text: "A sa√≠da direita da c√¢mara escura leva a uma cripta. Sarc√≥fagos de pedra revestem as paredes e o ar √© pesado com o cheiro de poeira e pedra velha. A luz da lua entra pelas rachaduras no teto, lan√ßando sombras misteriosas. Uma pesada porta de pedra est√° localizada na parede oposta.",
                    choices: [{
                        text: "Entrar na porta da direita",
                        nextScene: "crypt_merchant"
                    }, {
                        text: "Ira at√© a porta do fundo da cripta",
                        nextScene: "crypt_door",
                        requiresCheck: true,
                        checkType: "str"
                    }, {
                        text: "Examine os sarc√≥fagos",
                        nextScene: "crypt_sarcophagi"
                    }]
                },
                crypt_merchant: {
                    text: "A passagem da cripta se estreita at√© abrir-se em uma alcova sombria e √∫mida sem sa√≠da, iluminada apenas pelo brilho fraco de uma √∫nica lanterna pendurada em um gancho enferrujado na parede. O ar √© pesado com o cheiro de mofo e terra antiga, misturado a um leve aroma acre que voc√™ n√£o consegue identificar. Sarc√≥fagos quebrados alinham-se √†s paredes, suas tampas rachadas revelando escurid√£o vazia. No centro da alcova, uma figura encapuzada est√° de p√©, im√≥vel, como se fosse parte das sombras.\n\nO mercador n√£o se vira imediatamente. Seu rosto est√° oculto por um capuz negro esfarrapado, mas voc√™ vislumbra o brilho de olhos atentos sob a borda do tecido. Ele segura um cajado nodoso, cravejado de pequenos cristais opacos, e sua voz, quando finalmente fala, √© rouca e baixa, como o sussurro de folhas secas: 'Ol√°, estranho! Poucos chegam at√© aqui... vivos. Tenho mercadorias raras, se tiver ouro e coragem para pagar o pre√ßo.'\n\nSobre uma manta pu√≠da esticada no ch√£o, ele exibe seus itens: uma po√ß√£o turva que parece pulsar com luz pr√≥pria, uma adaga de cabo esculpido em osso, um amuleto pendurado em uma corrente de ferro manchada e um rolo de corda que parece estranhamente √∫mida ao toque entre outras coisas. O mercador inclina a cabe√ßa, esperando sua decis√£o, enquanto o som distante de algo arranhando pedra ecoa pela cripta.",
                    choices: [
                        {
                            text: "Examinar os itens do mercador",
                            nextScene: "merchant_items"
                        }, {
                            text: "Perguntar quem ele √©",
                            nextScene: "merchant_question"
                        }, {
                            text: "Ignorar o mercador e seguir para a porta ao fundo da cripta",
                            nextScene: "crypt_door",
                            requiresCheck: true,
                            checkType: "str"
                        }, {
                            text: "Tentar roub√°-lo",
                            nextScene: "merchant_steal_fail"
                        }
                    ],
                    "onEnter": function() {
                        alert("Over rir, stchruendjah!")
                        addToLog("üè¥‚Äç‚ò†Ô∏è Voc√™ sente um calafrio ao olhar para o mercador. H√° algo errado com ele...");
                    }
                },
                merchant_question: {
                    text: "Voc√™ pergunta para o mercador: Voc√™ n√£o √© o carinha que vende coisas no Resident Evil 4? Ao que ele responde: Eu n√£o fa√ßo ideia do que voc√™ est√° falando... Sou apenas um viajante vindo da espanha para fugir de uma praga que estava infectando todo mundo.",
                    choices: [
                        {
                            text: "Examinar os itens do mercador",
                            nextScene: "merchant_items"
                        }, {
                            text: "Ignorar o mercador e seguir para a porta ao fundo da cripta",
                            nextScene: "crypt_door",
                            requiresCheck: true,
                            checkType: "str"
                        }, {
                            text: "Tentar roub√°-lo",
                            nextScene: "merchant_steal_fail"
                        }
                    ]
                },
                merchant_items: {
                    text: "Voc√™ pergunta para o mercador: Voc√™ n√£o √© o carinha que vende coisas no Resident Evil 4? Ao que ele responde: Eu n√£o fa√ßo ideia do que voc√™ est√° falando... Sou apenas um viajante vindo da espanha para fugir de uma praga que estava infectando todo mundo.",
                    choices: [{
                        text: "Voltar e tentar abrir a porta de pedra ao fundo da cripta",
                        nextScene: "crypt_door",
                        requiresCheck: true,
                        checkType: "str"
                    }, {
                        text: "Voltar e examinar os sarc√≥fagos",
                        nextScene: "crypt_sarcophagi"
                    }],
                    onEnter: function() {
                        playerGoldElement.textContent = `Ouro: ${gameState.player.gold}`;
                        shopModal.classList.remove('hidden');
                        addToLog("üéÅ Hora das compras!!!")
                    }
                },
                merchant_steal_fail: {
                    text: "Voc√™ se aproxima sutilmente do mercador enquanto balbucia algumas coisas como se estivesse pensando em voz alta enquato olha os itens de perto e quando ele olha para o lado, voc√™ tenta discretamente e rapidamente pegar uma po√ß√£o m√°gica misteriosa e coloca no bolso. Quando o mercador vira o rosto de volta voc√™ diz que n√£o h√° nada de interessante no momento e que talvez volte depois, pois tem coisas mais imoprtantes pra fazer. Voc√™ vira de costas e sai andando tranquilamente.",
                    choices: [{
                        text: "Seguir normalmente para examinar os sarc√≥fagos",
                        nextScene: "merchant_kill_you"
                    }, {
                        text: "Voltar para devolver a po√ß√£o",
                        nextScene: "merchant_steal_cancel"
                    }]
                },
                merchant_steal_cancel: {
                    text: "Voc√™ volta arrependido de ter roubado a po√ß√£o e decide voltar para devolver, mas a vergonha √© tanta que voc√™ prefere devolver sem que ele veja. Voc√™ puxa assunto e quando ele n√£o est√° vendo voc√™ devolve a po√ß√£o sem ele perceber.",
                    choices: [{
                        text: "Examinar os itens do mercador",
                        nextScene: "merchant_items"
                    }, {
                        text: "Perguntar quem ele √©",
                        nextScene: "merchant_question"
                    }, {
                        text: "Se despedir do mercador e seguir para a porta dos fundos da cripta",
                        nextScene: "crypt_door",
                        requiresCheck: true,
                        checkType: "str"
                    }]
                },
                merchant_kill_you: {
                    text: "Voc√™ se afasta rapidamente em dire√ß√£o aos sarc√≥fagos e percebe que um deles est√° entreaberto, voc√™ se aproxima curioso para olhar o que tem dentro e percebe que √© o seu voc√™ mesmo dentro do sarc√≥fago, p√°lido e duro com o rosto retorcido, voc√™ fica sem entender nada e ao olhar para o seu pr√≥prio corpo percebe que se tornou um fantasma errante. Seus itens sumiram, suas roupas se tornaram trapos escuros e sujos e sua mente nublada quase como se estivesse em um sonho fica cada vez mais cansada e sem vontade de lutar. Voc√™ pensa: 'Foi o mercador? Mas como? Ele viu que eu roubei?', mas sua mente cansada e sonolenta desiste de elaborar conjecturas sucumbe perdendo completamente a consci√™ncia. Sua √∫ltima vis√£o √© do mercador olhando para voc√™ e rindo alto 'Aaahhh! Aiu bai irira rai pruaici!' Sua aventura termina aqui, em uma cripta secreta vagando como um fantasma errante.",
                    choices: [] // Sem escolhas em uma cena de morte. Fim de jogo.
                },
                crypt_door_success: {
                    text: "Com um grunhido de esfor√ßo, voc√™ consegue mover a pesada porta de pedra. Ela se abre lentamente, revelando uma passagem escura al√©m. Voc√™ ouve um leve sussurro de vento vindo de dentro.",
                    choices: [{
                        text: "Entre na passagem al√©m",
                        nextScene: "crypt_puzzle_entrance"
                    }],
                    "onEnter": function() {
                        changeXP(15);
                    }
                },
                crypt_door_failure: {
                    text: "A porta de pedra √© muito pesada e inflex√≠vel. Voc√™ se esfor√ßa contra ela, mas ela n√£o se move. Parece selada.",
                    choices: [{
                        text: "Procure outra maneira de abri-la",
                        nextScene: "crypt_parchment_read"
                    },
                    {
                        text: "Examine os sarc√≥fagos",
                        nextScene: "crypt_sarcophagi"
                    }]
                },
                crypt_sarcophagi: {
                    text: "Voc√™ examina os sarc√≥fagos. Eles s√£o feitos de pedra fria e √°speras, alguns esculpidos com imagens de guerreiros de rosto severo e figuras vestidas com mantos. A tampa de um sarc√≥fago parece ligeiramente torta...",
                    choices: [{
                        text: "Tente abrir o sarc√≥fago torto",
                        nextScene: "crypt_sarcophagus_open",
                        requiresCheck: true,
                        checkType: "intelligence"
                    }, {
                        text: "Tente abrir a porta de pedra novamente",
                        nextScene: "crypt_door",
                        requiresCheck: true,
                        checkType: "str"
                    }, {
                        text: "Retornar ao inicio da cripta para garantir que n√£o esqueceu de nada",
                        nextScene: "crypt"
                    }]
                },
                crypt_sarcophagus_open_success: {
                    text: "Com cuidado, voc√™ tenta levantar a tampa torta. Ela se move com surpreendente facilidade, revelando n√£o ossos, mas um compartimento escondido! Dentro h√° uma pequena caixa ornamentada e um pergaminho enrolado.",
                    choices: [{
                        text: "Abra a caixa",
                        nextScene: "crypt_box_open"
                    }],
                    "onEnter": function() {
                        changeXP(20);
                    }
                },
                crypt_sarcophagus_open_failure: {
                    text: "Voc√™ tenta abrir o sarc√≥fago, mas ele √© mais pesado do que parece. A tampa se move ligeiramente, mas permanece quase totalmente selada. Voc√™ n√£o pode for√ß√°-la a abrir sem fazer muito barulho.",
                    choices: [{
                        text: "Tente abrir a porta de pedra novamente",
                        nextScene: "crypt_door",
                        requiresCheck: true,
                        checkType: "str"
                    }, {
                        text: "Retornar ao inicio da cripta para garantir que n√£o esqueceu de nada",
                        nextScene: "crypt"
                    }]
                },
                crypt_box_open: {
                    text: "Dentro da caixa ornamentada, voc√™ encontra uma chave de prata brilhante e um punhado de pedras preciosas.",
                    choices: [{
                        text: "Voltar para tentar abrir a porta com a chave.",
                        nextScene: "crypt_door_success"
                    }],
                    "onEnter": function() {
                        addToInventory("Chave de Prata");
                        addToInventory("Pedras Preciosas");
                        changeGold(15);
                        changeXP(25);
                    }
                },
                crypt_parchment_read: {
                    text: "Tem algumas escrituras acima da porta quase impercept√≠veis devido ao ac√∫mulo de poeira, a escrita est√° em uma caligrafia elegante: \"Eu falo sem voz, guardo sem m√£os, e permane√ßo onde os vivos temem pisar. Sou encontrado em t√∫mulos, mas n√£o sou um cad√°ver. O que sou eu?\"",
                    choices: [{
                        "text": "Uma sombra",
                        "nextScene": "crypt_riddle_failure"
                    }, {
                        "text": "Um epit√°fio",
                        "nextScene": "crypt_riddle_success"
                    }, {
                        "text": "Um eco",
                        "nextScene": "crypt_riddle_failure"
                    }, {
                        "text": "Um tesouro",
                        "nextScene": "crypt_riddle_failure"
                    }],
                    "onEnter": function() {
                        addToLog("üè¥‚Äç‚ò†Ô∏è O vento para de repente quase como se observasse voc√™ em sil√™ncio, esperando sua resposta.");
                        gameState.pendingCheck = "riddle"; // Sinalizador para resolu√ß√£o de charadas na pr√≥xima cena
                    }
                },
                crypt_riddle_success: {
                    text: "O vento normaliza e voc√™ ouve um clique atras da porta como se tive destravado algum mecanismo que a trancava.",
                    choices: [
                        {
                            "text": "Abrir a porta",
                            "nextScene": "crypt_door_success"
                        }
                    ],
                    "onEnter": function() {
                        changeGold(20);
                        changeXP(15);
                        addToLog("üëç Parab√©ns!!! Voc√™ resolveu a charada!!!");
                    }
                },
                crypt_riddle_failure: {
                    text: "O vento volta a soprar forte, gelado e cortante e come√ßa infrinjir cortes na sua pele por todo seu corpo!",
                    choices: [{
                        text: "Tentar uma √∫ltima vez antes de seja tarde",
                        nextScene: "crypt_parchment_read"
                    }],
                    "onEnter": function() {
                        if (!gameState.player.inventory.includes("Po√ß√£o de cura")) {
                            scenes["crypt_riddle_failure"].choices.push({
                                text: "Tomar po√ß√£o!",
                                nextScene: "potion_health"
                            })
                            addChoiceInCurrentScene(scenes["crypt_riddle_failure"])
                        }
                        gameState.lastScene = "crypt_parchment_read"
                        changeHealth(-3)
                        addToLog("üè¥‚Äç‚ò†Ô∏è Voc√™ respondeu errado. O ar fica mais frio e agitado cortando sua pele...");
                    }
                },
                potion_health: {
                    text: "Voc√™ abre rapidamente o vidro de po√ß√µes regenerando seus ferimentos.",
                    choices: [],
                    onEnter: function() {
                        gameState.player.health = gameState.player.maxHealth;
                        addToLog("‚ù§Ô∏è Voc√™ toma a po√ß√£o e volta a ficar com " + gameState.player.health + " pontos de vida");
                        addToLog("‚¨ÖÔ∏è Voltando para a √∫ltima cena.");
                        setTimeout(() => {
                            loadScene(gameState.lastScene);
                        }, 1500)
                    }
                },
                crypt_puzzle_entrance: {
                    text: "Atr√°s da pesada porta de pedra ou talvez acionada pela charada, uma se√ß√£o da parede desliza para abrir, revelando uma c√¢mara oculta. S√≠mbolos estranhos est√£o gravados nas paredes e um padr√£o complexo de ladrilhos cobre o ch√£o.",
                    choices: [{
                        text: "Tente resolver o quebra-cabe√ßa de ladrilhos",
                        nextScene: "crypt_puzzle_result",
                        requiresCheck: true,
                        checkType: "int"
                    }, {
                        text: "Ignore o quebra-cabe√ßa e retorne √† cripta",
                        nextScene: "crypt"
                    }],
                    "onEnter": function() {
                        if (gameState.pendingCheck === "riddle") {
                            gameState.checkDifficulty = 8; // Teste mais dif√≠cil se a charada for resolvida.
                        } else {
                            gameState.checkDifficulty = 12; // Muito dif√≠cil se tentar for√ßar sem a charada.
                        }
                    }
                },
                crypt_puzzle_result_success: {
                    text: "Com cuidado ou talvez um lampejo de insight, voc√™ resolve o quebra-cabe√ßa! Os ladrilhos se encaixam e voc√™ ouve um mecanismo se desativando. Uma porta secreta se abre nas proximidades, revelando uma c√¢mara de tesouro!",
                    choices: [{
                        text: "Entre na c√¢mara de tesouro",
                        nextScene: "crypt_treasure_room"
                    }],
                    "onEnter": function() {
                        changeXP(40);
                    }
                },
                crypt_puzzle_result_failure: {
                    text: "Voc√™ pisa no ladrilho errado! O ch√£o treme e voc√™ ouve um clique. Dardos s√£o disparados das paredes e os ladrilhos sob seus p√©s se retraem, jogando voc√™ em um po√ßo raso! Voc√™ est√° ferido e envenenado!",
                    choices: [{
                        text: "Tente resolver o quebra-cabe√ßa novamente",
                        nextScene: "crypt_puzzle_result",
                        requiresCheck: true,
                        checkType: "int"
                    }],
                    "onEnter": function() {
                        if (!gameState.player.inventory.includes("Po√ß√£o de cura")) {
                            scenes["crypt_puzzle_result_failure"].choices.push({
                                text: "Tomar po√ß√£o!",
                                nextScene: "potion_health"
                            })
                            addChoiceInCurrentScene(scenes["crypt_puzzle_result_failure"]);
                        }
                        changeHealth(-4);
                        gameState.lastScene = "crypt_puzzle_entrance";
                    }
                },
                crypt_treasure_room: {
                    text: "Voc√™ entra em uma pequena c√¢mara cheia de tesouros brilhantes! Moedas de ouro est√£o empilhadas, ba√∫s transbordando de joias e artefatos antigos brilham √† luz da tocha. √â um tesouro digno de um rei ou de um aventureiro muito bem-sucedido!",
                    choices: [{
                        text: "Re√∫na o tesouro",
                        nextScene: "crypt_treasure_gather"
                    }, {
                        text: "Seja cauteloso, verifique se h√° mais armadilhas",
                        nextScene: "crypt_treasure_traps",
                        requiresCheck: true,
                        checkType: "int"
                    }]
                },
                crypt_treasure_traps_success: {
                    text: "Sua cautela se mostra s√°bia. Ap√≥s uma inspe√ß√£o mais detalhada, voc√™ descobre placas de press√£o sutis ao redor das pilhas de tesouro e fios finos quase invis√≠veis contra o ouro brilhante. Voc√™ desarma cuidadosamente as armadilhas mais √≥bvias.",
                    choices: [{
                        text: "Agora re√∫na o tesouro",
                        nextScene: "crypt_treasure_gather"
                    }],
                    "onEnter": function() {
                        changeXP(30);
                    }
                },
                crypt_treasure_traps_failure: {
                    text: "Apesar de suas tentativas de encontrar armadilhas, voc√™ n√£o v√™ uma placa de press√£o oculta. Ao entrar mais na c√¢mara de tesouro, voc√™ ouve um estalo agudo! Uma rede cai do teto, prendendo voc√™!",
                    choices: [{
                        text: "Lute contra a rede",
                        nextScene: "crypt_net_escape",
                        requiresCheck: true,
                        checkType: "strength"
                    }, {
                        text: "Tente desembara√ßar a rede com cuidado",
                        nextScene: "crypt_net_untangle",
                        requiresCheck: true,
                        checkType: "dex"
                    }],
                    "onEnter": function() {
                        changeHealth(-2); // Dano leve da armadilha de rede
                    }
                },
                crypt_net_escape_success: {
                    text: "Com for√ßa bruta, voc√™ se esfor√ßa contra a rede, testando seus pontos fracos. Cordas se partem e rasgam, e voc√™ consegue se libertar, embora a rede agora esteja em farrapos.",
                    choices: [{
                        text: "Finalmente re√∫na o tesouro!",
                        nextScene: "crypt_treasure_gather"
                    }],
                    "onEnter": function() {
                        changeHealth(-3); // Esfor√ßo adicional para escapar da rede
                    }
                },
                crypt_net_escape_failure: {
                    text: "Voc√™ luta contra a rede, mas ela √© muito forte. Quanto mais voc√™ se debate, mais apertada ela parece prend√™-lo. Voc√™ est√° preso, pelo menos por enquanto.",
                    choices: [{
                            text: "Tente desembara√ßar a rede com mais cuidado",
                            nextScene: "crypt_net_untangle",
                            requiresCheck: true,
                            checkType: "dex"
                        }, {
                            text: "Desista do tesouro e tente escapar da rede",
                            nextScene: "crypt_net_escape_give_up"
                        } // Nova rota de fuga se o tesouro for abandonado
                    ],
                    "onEnter": function() {
                        changeHealth(-4); // Mais dano por lutar
                    }
                },
                crypt_net_untangle_success: {
                    text: "Com dedos √°geis e movimentos cuidadosos, voc√™ trabalha nos n√≥s da rede. Lentamente, mas com seguran√ßa, voc√™ cria folga e, eventualmente, se liberta. Levou tempo e paci√™ncia, mas voc√™ n√£o est√° mais preso.",
                    choices: [{
                        text: "Agora, cautelosamente, re√∫na o tesouro",
                        nextScene: "crypt_treasure_gather"
                    }],
                    "onEnter": function() {
                        changeXP(20); // XP por intelig√™ncia
                    }
                },
                crypt_net_untangle_failure: {
                    text: "Os n√≥s da rede s√£o muito complexos ou seus dedos s√£o muito desajeitados em sua pressa e p√¢nico. Voc√™ parece n√£o conseguir se desembara√ßar. A rede permanece firmemente no lugar.",
                    choices: [{
                        text: "Lute novamente com for√ßa bruta",
                        nextScene: "crypt_net_escape",
                        requiresCheck: true,
                        checkType: "str"
                    }, {
                        text: "Desista do tesouro e tente escapar da rede",
                        nextScene: "crypt_net_escape_give_up"
                    }]
                },
                crypt_net_escape_give_up: {
                    text: "Percebendo que o tesouro pode ser muito arriscado, voc√™ concentra todos os seus esfor√ßos em apenas escapar da rede. Voc√™ procura um mecanismo de libera√ß√£o ou outra fraqueza na armadilha... Mas n√£o h√° nada que possa lhe salver nesse momento.",
                    choices: [{
                        text: "Aceite seu destino...",
                        nextScene: "death_net_trap"
                    }],
                    "onEnter": function() {
                        changeHealth(-5);
                    }
                },
                death_net_trap: {
                    text: "Preso e exausto, voc√™ sucumbe aos seus ferimentos ou aos outros perigos da masmorra. Sua aventura termina aqui, em uma c√¢mara de tesouro que voc√™ n√£o conseguiu reivindicar.",
                    choices: [], // Sem escolhas em uma cena de morte. Fim de jogo.
                    "onEnter": function() {
                        addToLog("‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è Voc√™ morreu ‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è");
                    }
                },
                crypt_treasure_gather: {
                    text: "Voc√™ cuidadosamente junta punhados de moedas de ouro, coloca joias em suas bolsas e admira os artefatos antigos. Voc√™ acumulou um tesouro significativo da cripta!",
                    choices: [{
                        text: "Deixe a cripta, carregado de tesouro",
                        nextScene: "crypt_exit"
                    }],
                    "onEnter": function() {
                        changeGold(100);
                        addToInventory("Artefatos Antigos");
                        changeXP(50);

                    }
                },
                crypt_exit: {
                    text: "Voc√™ retorna sobre seus passos, deixando a cripta e voltando para a c√¢mara escura, passando pelos cristais at√© a c√¢mara de cristais onde voc√™ caiu na cripta. Voc√™ sabe que provavelmente n√£o explorou tudo o que tinha l√° embaixo, mas isso n√£o importa, o que realmente importa √© que voc√™ conseguiu sair com vida e ainda com um bom tesouro acumulado.",
                    choices: [{
                        text: "Explorar a c√¢mara de cristais para ver se encontra mais tesouros",
                        nextScene: "crystal_cave_exits_alternative"
                    }, {
                        text: "Deixe a masmorra com seu saque",
                        nextScene: "victory_partial"
                    }],
                    "onEnter": function() {
                        addToLog("üì® Vai arregar? ou vai continuar explorando a caverna? ü§î");
                    }
                },
                victory_partial: {
                    text: "Voc√™ emerge da Masmorra de Drakmor, piscando sob a luz do sol. Voc√™ est√° cansado e talvez ferido, mas tamb√©m significativamente mais rico e experiente. Voc√™ enfrentou a masmorra e reivindicou uma parte de seu tesouro. Talvez voc√™ retorne um dia para se aprofundar mais...",
                    choices: [],
                    onEnter: function() {
                        addToLog("üì® Aaaaarreg√£o!!! üòí");
                        setTimeout(() => {
                            alert("üéä Obrigado por jogar! üéâ")
                        }, 7500);
                    }
                },
                last_fight: {
                    text: "De repente, um grito estridente ecoou pela masmorra, interrompendo o sil√™ncio sepulcral. Um arrepio percorreu a espinha do aventureiro, e ele se virou para ver o que causou o barulho. \nAtr√°s dele, na escurid√£o que se estendia al√©m da luz da tocha, uma figura fantasmag√≥rica emergiu das sombras. Era alto, emaciado, com olhos vermelhos brilhantes e uma estrutura esquel√©tica. Sua pele era p√°lida e transl√∫cida, revelando as veias e os m√∫sculos por baixo. \nEle usava vestes esfarrapadas e carregava uma foice pingando sangue. Ele se movia com uma gra√ßa sobrenatural, seus passos silenciosos e seus movimentos r√°pidos. \nA presen√ßa do espectro encheu o ar com um sentimento palp√°vel de maldade e terror. O espectro avan√ßou, seu olhar fixo no aventureiro. Ele ergueu sua foice, pronto para atacar.",
                    choices: [{
                        text: "Lutar contra o fantasma de Drakmor",
                        nextScene: "pre_victory",
                        requiresCheck: true,
                        checkType: "combat"
                    }],
                    onEnter: function() {
                        gameState.currentEnemy = {
                            name: "Fantasma de Drakmor",
                            ac: 18,
                            hp: 40,
                            max_hp: 40,
                            str: 16,
                            dex: 14,
                            con: 10,
                            bba: 4
                        }
                    }
                },
                pre_victory: {
                    text: "O √∫ltimo golpe mortal √© desferido no fantasma fazendo-o urrar de dor em seu √∫ltimo lamento da eternidade! O fantasma brilha forte antes de explodir em uma esfera de energia magn√©tica que faz a caverna estremecer e come√ßar a desmoronar!",
                    choices: [{
                        text: "Fugir correndo da caverna",
                        nextScene: "victory"
                    }]
                },
                victory: {
                    text: "Voc√™ est√° triunfante na c√¢mara, com a Espada Joia de Drakmor em sua m√£o e uma riqueza incomensur√°vel a seus p√©s. Voc√™ superou os desafios da Masmorra de Drakmor e reivindicou seu maior tesouro! Lendas ser√£o cantadas sobre seu nome!",
                    choices: [], // Vit√≥ria verdadeira, fim de jogo.
                    onEnter: function() {
                        addToLog("üéä Parab√©ns!!! esse √© o melhor final!! Obrigado por jogar!! üéâ");
                        setTimeout(() => {
                            alert("üéä Parab√©ns!!! esse √© o melhor final!! Obrigado por jogar!! üéâ");
                        }, 7500);
                    }
                },
                death: {
                    text: "Sua sa√∫de diminui para zero. A escurid√£o o reivindica enquanto voc√™ sucumbe aos seus ferimentos ou aos perigos da masmorra. Sua aventura termina aqui...",
                    choices: [], // Fim de jogo
                    onEnter: function() {
                        addToLog("‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è Voc√™ morreu! ‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è");
                    }
                }
            }


            let selectedCharacter = null;



            /**
             * Tenta popular a lista de vozes dispon√≠veis e selecionar uma voz pt-BR.
             * Precisa ser chamada AP√ìS a intera√ß√£o do usu√°rio e/ou no evento 'voiceschanged'.
             */
            function populateVoiceList() {
                if (!synth) return; // Sai se a API n√£o for suportada

                voices = synth.getVoices().sort(function (a, b) {
                    const aname = a.name.toUpperCase();
                    const bname = b.name.toUpperCase();
                    if (aname < bname) return -1;
                    else if (aname == bname) return 0;
                    else return +1;
                });
                console.log("Vozes dispon√≠veis:", voices);

                // Tenta encontrar uma voz em Portugu√™s do Brasil
                selectedVoice = voices.find(voice => voice.name.includes('Daniel - Portuguese') || voice.name.includes('Maria - Portuguese'));

                 // Fallback para outras pt-BR ou qualquer pt
                if (!selectedVoice) {
                     selectedVoice = voices.find(voice => voice.lang === 'pt-BR');
                }
                 if (!selectedVoice) {
                    selectedVoice = voices.find(voice => voice.lang.startsWith('pt-'));
                }
                 // Fallback final para a primeira voz dispon√≠vel
                 if (!selectedVoice && voices.length > 0) {
                     selectedVoice = voices[0];
                 }

                 if (selectedVoice) {
                     console.log("Voz selecionada:", selectedVoice.name, selectedVoice.lang);
                 } else {
                     console.warn("Nenhuma voz pt-BR encontrada ou API n√£o retornou vozes ainda.");
                 }
            }

            /**
             * L√™ o texto fornecido usando a Web Speech API.
             * @param {string} text - O texto a ser lido.
             */
            function speakText(text) {
                if (!ttsEnabled || !synth || !speechApiUnlocked || !text) {
                     console.log("TTS desabilitado, API n√£o pronta/desbloqueada ou texto vazio.");
                     return; // Sai se TTS desabilitado, API n√£o dispon√≠vel/desbloqueada ou texto vazio
                }

                // Cancela qualquer fala anterior para evitar sobreposi√ß√£o
                stopSpeech();

                // Cria a "declara√ß√£o" (utterance)
                utterance = new SpeechSynthesisUtterance(text);

                utterance.onend = function() {
                    console.log("Narra√ß√£o conclu√≠da.");
                    utterance = null; // Limpa a refer√™ncia
                };

                utterance.onerror = function(event) {
                    console.error("Erro na s√≠ntese de fala:", event.error);
                    utterance = null; // Limpa a refer√™ncia
                };

                // Tenta usar a voz pt-BR selecionada
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                     utterance.lang = selectedVoice.lang; // Garante a l√≠ngua correta
                 } else {
                     // Se nenhuma voz espec√≠fica foi encontrada, define o idioma
                     // para dar uma dica ao navegador, mesmo que use a voz padr√£o.
                     utterance.lang = 'pt-BR';
                     console.warn("Usando voz padr√£o para pt-BR.");
                 }

                // (Opcional) Ajustar taxa e tom
                utterance.rate = 1.0; // 0.1 a 10 (1 = normal)
                utterance.pitch = 1.0; // 0 a 2 (1 = normal)

                // Tenta falar (pode precisar de resume se o contexto estava suspenso)
                if (synth.paused) {
                     synth.resume(); // Se estava pausado, retoma
                 }
                synth.speak(utterance);
                console.log("Tentando narrar:", text.substring(0, 30) + "...");
            }

            /**
             * Interrompe a narra√ß√£o atual.
             */
            function stopSpeech() {
                if (synth && synth.speaking) {
                    console.log("Cancelando narra√ß√£o anterior.");
                    synth.cancel();
                }
                // Tamb√©m remove qualquer utterance pendente na fila, embora cancel() geralmente fa√ßa isso.
                 if (utterance) {
                    // utterance = null; // N√£o necessariamente nulo aqui, cancel deve tratar
                 }
            }

            // --- Fim Fun√ß√µes de Fala ---

            function selectCharacter(characterClass) {
                //Remove previous selection
                if (selectedCharacter) {
                    document.querySelector(`.character-card.selected`).classList.remove('selected');
                }
                selectedCharacter = characterClass;
                document.querySelector(`.character-card[data-class='${characterClass}']`).classList.add('selected');
            }

            /**
             * Exibe texto em um elemento com efeito de m√°quina de escrever.
             * @param {HTMLElement} element - O elemento HTML onde o texto ser√° exibido.
             * @param {string} text - O texto completo a ser digitado.
             * @param {number} [speed=40] - O intervalo em milissegundos entre cada caractere.
             * @param {function} [callback] - Fun√ß√£o a ser chamada quando a digita√ß√£o terminar.
             * @returns {number} - O ID do intervalo (para poder limpar externamente).
             */
            function typewriterEffect(element, text, speed = 40, callback) {
                if (!element) {
                    console.error("Elemento para typewriter n√£o encontrado!");
                    return null;
                }
                 if (currentTypewriterInterval) { // Limpa qualquer intervalo anterior
                    clearInterval(currentTypewriterInterval);
                }

                element.textContent = ''; // Limpa o texto inicial
                let i = 0;
                skipTyping = false; // Reseta a flag de pular

                currentTypewriterInterval = setInterval(() => {
                    if (skipTyping) { // Verifica se o jogador quer pular
                         clearInterval(currentTypewriterInterval);
                         currentTypewriterInterval = null;
                         element.textContent = text; // Exibe todo o texto
                         if (callback) callback(); // Executa o callback
                         return;
                     }

                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(currentTypewriterInterval); // Para o intervalo
                        currentTypewriterInterval = null;
                        skipTyping = false; // Reseta a flag ao concluir
                        if (callback) {
                            callback(); // Chama a fun√ß√£o de callback ao terminar
                        }
                    }
                }, speed);

                return currentTypewriterInterval; // Retorna o ID para refer√™ncia
            }

            /**
             * Fun√ß√£o para habilitar os bot√µes de escolha.
             */
            function enableChoices() {
                const choiceButtons = document.querySelectorAll('#choices button');
                choiceButtons.forEach(button => button.disabled = false);
                // Habilita novamente o clique para pular, se necess√°rio (opcional)
                // setupSkipListener(); // Chamaria uma fun√ß√£o que adiciona o listener se ele foi removido
            }

            /**
             * Fun√ß√£o para desabilitar os bot√µes de escolha.
             */
            function disableChoices() {
                 const choiceButtons = document.querySelectorAll('#choices button');
                 choiceButtons.forEach(button => button.disabled = true);
            }

            /**
             * Configura o listener para pular a digita√ß√£o
             */
            function setupSkipListener() {
                const sceneTextElement = document.getElementById('scene-text');
                if (!sceneTextElement) return;

                // Remove listener antigo para evitar m√∫ltiplos gatilhos
                sceneTextElement.removeEventListener('click', handleSkipTyping);
                // Adiciona novo listener
                sceneTextElement.addEventListener('click', handleSkipTyping, { once: true }); // 'once: true' remove o listener ap√≥s o primeiro clique
             }

            /**
             * Handler para o clique que pula a digita√ß√£o
             */
            function handleSkipTyping() {
                if (currentTypewriterInterval) {
                    console.log("Pulando digita√ß√£o...");
                    skipTyping = true; // Sinaliza para o intervalo terminar e exibir tudo
                }
            }

            function startGame() {
                if (!selectedCharacter) {
                    alert("‚ÅâÔ∏è Escolha um personagem antes de iniciar a aventura.");
                    return;
                }
                //Initialize game state based on selected character
                gameState.player.class = selectedCharacter;
                gameState.player.stats = characterStats[selectedCharacter];
                gameState.player.health = gameState.player.maxHealth = 20; // Reset health for new game
                // Hide character selection and show game screen
                // document.getElementById('character-select').classList.add('hidden');
                // document.getElementById('game-screen').classList.remove('hidden');
                // document.getElementById('game-log').classList.remove('hidden');
                // document.getElementById('image-container').classList.remove('hidden');

                document.getElementById('character-select').classList.add('hidden');
                document.getElementById('col1-area').classList.remove('hidden');
                document.getElementById('col2-area').classList.remove('hidden');
                document.getElementById('col3-area').classList.remove('hidden');
                document.getElementById('game-screen').classList.remove('hidden');

                //Start the game with the 'start' scene
                loadScene('start');
                updateStatsDisplay();
            }

            function verificarImagem(idImagem, srcAlternativo) {
                const imagem = document.getElementById(idImagem);
                const src = imagem.src;

                const testeImagem = new Image();
                testeImagem.src = src;

                testeImagem.onload = function() {
                    console.log("Imagem carregada com sucesso!");
                    gameState.lastImage = src;
                };

                testeImagem.onerror = function() {
                    console.log("Erro ao carregar a imagem.");
                    if (srcAlternativo) {
                        imagem.src = srcAlternativo;
                        console.log("Imagem substitu√≠da por: " + srcAlternativo);

                        const testeImagem2 = new Image();
                        testeImagem2.src = srcAlternativo;

                        testeImagem2.onload = function() {
                            console.log("Imagem carregada com sucesso!");
                            gameState.lastImage = srcAlternativo;
                        };

                        testeImagem2.onerror = function() {
                            console.log("Erro ao carregar a imagem.");
                            if (srcAlternativo) {
                                imagem.src = gameState.lastImage;
                                console.log("Imagem substitu√≠da por: " + gameState.lastImage);
                            }
                        };
                    }
                };
            }

            function changeImage(sceneName) {
                const imgElement = document.getElementById("image");
                const src = "./images/"+sceneName;
                const extPng = ".png";
                const extJpg = ".jpeg";

                imgElement.src = src + extPng;
                verificarImagem("image", src + extJpg);
            }

            function loadScene(sceneName) {

                stopSpeech();

                // Limpa qualquer digita√ß√£o anterior em andamento
                if (currentTypewriterInterval) {
                    clearInterval(currentTypewriterInterval);
                    currentTypewriterInterval = null;
                    skipTyping = false; // Reseta a flag
                }
                
                changeImage(sceneName);

                console.log("gameState", JSON.stringify(gameState, undefined, 4));
                console.log("sceneName", sceneName);
                
                gameState.currentScene = sceneName;
                const scene = scenes[sceneName];
                
                console.log("scene", scene);
                
                const sceneTextElement = document.getElementById('scene-text');
                if (!sceneTextElement) {
                    console.log("o elemento sumiu!");
                    const sceneTextDiv = document.createElement('div');
                    sceneTextDiv.id = 'scene-text';
                    sceneTextDiv.textContent = 'Esta √© a cena do jogo!'; // Adiciona um texto de exemplo
                    // Encontra a div com o id "game-screen"
                    const gameScreenDiv = document.getElementById('game-screen');
                    if (gameScreenDiv == null || gameScreenDiv == undefined) {
                        console.log("cade essa baga√ßa de div?");
                    }
                    // Adiciona a div "scene-text" como filha da div "game-screen"
                    gameScreenDiv.appendChild(sceneTextDiv);
                    sceneTextElement = sceneTextDiv;
                }

                speakText(scene.text); // Tenta ler o texto da cena

                const diceContainer = document.getElementById('dice-container');
                const resultMessageElement = document.getElementById('result-message');
                console.log("sceneTextElement", sceneTextElement);

                sceneTextElement.textContent = '...'; // Placeholder enquanto digita

                // --- Modifica√ß√£o Principal ---
                disableChoices(); // Desabilita escolhas enquanto o texto √© digitado

                choicesElement.innerHTML = ''; // Limpa escolhas antigas IMEDIATAMENTE

                diceContainer.classList.add('hidden'); // Esconde dados por padr√£o
                resultMessageElement.classList.add('hidden'); // Esconde mensagem por padr√£o

                //sceneTextElement.textContent = scene.text;

                // Inicia o efeito de digita√ß√£o, passando a fun√ß√£o para habilitar escolhas como callback
                typewriterEffect(sceneTextElement, scene.text, 40, () => {
                     // --- Este c√≥digo executa DEPOIS que a digita√ß√£o termina ---
                     console.log("Digita√ß√£o conclu√≠da para:", sceneName);
                     // Adiciona as escolhas SOMENTE AP√ìS a digita√ß√£o (ou skip)
                     addChoiceInCurrentScene(scene, diceContainer, choicesElement); // Passa choicesElement
                     enableChoices(); // Reabilita as escolhas
                 });

                 // Configura o listener para permitir pular a digita√ß√£o atual
                 setupSkipListener();

                //Add choices for the current scene
                addChoiceInCurrentScene(scene, diceContainer);

                diceContainer.classList.add('hidden'); // Hide dice by default
                resultMessageElement.classList.add('hidden'); // Hide result message by default

                // Run onEnter function if it exists for the scene
                if (scene.onEnter) {
                    scene.onEnter();
                }
                // Reset check difficulty after scene load
                gameState.checkDifficulty = 10;
            }

            function addChoiceInCurrentScene(scene, diceContainer, choicesElement) {
                if (!choicesElement) {
                    choicesElement = document.getElementById('choices'); // Fallback se n√£o for passado
                }

                //Clear existing choices
                choicesElement.innerHTML = '';

                scene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.textContent = choice.text;
                    button.onclick = () => {
                        
                        // Ao clicar na escolha, remove o listener de skip da cena atual
                        const sceneTextElement = document.getElementById('scene-text');
                        if (sceneTextElement) sceneTextElement.removeEventListener('click', handleSkipTyping);

                        if (choice.requiresCheck) {
                            gameState.mem = {
                                nextSceneSuccess: scenes[`${choice.nextScene}_success`] ? `${choice.nextScene}_success` : choice.nextScene,
                                nextSceneFailure: scenes[`${choice.nextScene}_failure`] ? `${choice.nextScene}_failure` : choice.nextScene,
                                checkType: choice.checkType
                            };
                            if (!diceContainer) {
                                diceContainer = document.getElementById('dice-container');
                            }
                            diceContainer.classList.remove('hidden');
                            choicesElement.classList.add('hidden'); // Hide choices during dice roll
                        } else {
                            loadScene(choice.nextScene);
                        }
                    };
                    choicesElement.appendChild(button);
                });

                choicesElement.classList.remove('hidden'); // Ensure choices are visible when scene loads
            }

            function rollingDice(sides = 6, num = 1) {
                return Array.from({length: num}, () => Math.floor(Math.random() * sides) + 1);
            }

            function activeDiceButton() {
                const diceButton = document.getElementById('dice-button');
                diceButton.disabled = false;
            }

            function disactiveDiceButton() {
                const diceButton = document.getElementById('dice-button');
                diceButton.disabled = true;
            }

            function rollDice() {
                //disabilitar o bot√£o
                disactiveDiceButton();

                const diceResult = Math.floor(Math.random() * 20) + 1;
                document.getElementById('dice').textContent = diceResult;
                const resultMessageElement = document.getElementById('result-message');
                setTimeout(() => {
                    const diceContainer = document.getElementById('dice-container');
                    choicesElement = document.getElementById('choices');
                    let checkSuccess = false;

                    if (gameState.mem.checkType === "combat") {
                        initFight(gameState.currentEnemy);
                        checkSuccess = true;
                    } else {
                        let modifiedRoll = 0;

                        let logMessage = `Resultado da rolagem de dado: ${diceResult} para a categoria de teste: ${gameState.mem.checkType}. `;
                          
                        if (gameState.mem.checkType === 'luck') { // No stat modifier for luck checks - raw d20 roll.
                            modifiedRoll = diceResult; // Luck checks are raw d20 rolls
                        }

                        const statValue = Math.floor((gameState.player.stats[gameState.mem.checkType] - 10)/2); // Get relevant stat
                        modifiedRoll = diceResult;

                        if (statValue !== undefined) {
                            modifiedRoll += statValue;
                            logMessage += `\nModificador status +${statValue}. resultado da rolagem: ${modifiedRoll}. `;
                        }

                        if (modifiedRoll >= gameState.checkDifficulty) {
                            checkSuccess = true;
                            resultMessageElement.textContent = "Success!";
                            resultMessageElement.classList.remove('failure');
                            resultMessageElement.classList.add('success');
                            logMessage += `\nüëç Sucesso no teste de dificuldade: ${gameState.checkDifficulty}.`;
                        } else {
                            resultMessageElement.textContent = "Failure!";
                            resultMessageElement.classList.remove('success');
                            resultMessageElement.classList.add('failure');
                            logMessage += `\nüëé Falha no teste de dificuldade: ${gameState.checkDifficulty}.`;
                        }
                        resultMessageElement.classList.remove('hidden');
                        addToLog(logMessage);
                    }

                    diceContainer.classList.add('hidden');
                    choicesElement.classList.remove('hidden'); // Re-enable choices after roll
                    // Set timeout to load next scene after showing result message (e.g., 1.5 seconds)
                    setTimeout(() => {
                        console.log("gameState.mem", gameState.mem);
                        console.log("gameState.currentScene", gameState.currentScene);
                        if (checkSuccess) {
                            if (!gameState.mem.nextSceneSuccess) {
                                loadScene(gameState.currentScene + "_success");
                            } else {
                                loadScene(gameState.mem.nextSceneSuccess);
                            }
                        } else {
                            if (!gameState.mem.nextSceneFailure) {
                                loadScene(gameState.currentScene + "_failure");
                            } else {
                                loadScene(gameState.mem.nextSceneFailure);
                            }
                        }
                    }, 1000); // Wait 1.5 seconds before loading next scene
                    gameState.pendingCheck = null; //Clear pending check
                    document.getElementById('dice').textContent = "üé≤"
                    activeDiceButton();
                }, 1500);
                
            }

            function initFight(enemy) {
                do {
                    fight(enemy)
                } while(enemy.hp > 0 && gameState.player.health > 0)
            }

            function fight(enemy) {

                let atkBonus = 0;

                if (gameState.player.inventory.includes("Adaga")) {
                    atkBonus = 2;
                    addToLog(`üíÄ A adaga de ossos lhe d√° +${atkBonus} de ataque.`);
                }
                if (gameState.player.inventory.includes("Espada")) {
                    atkBonus = 3;
                    addToLog(`‚öîÔ∏è A espada lhe d√° +${atkBonus} de ataque.`);
                }
                if (gameState.player.inventory.includes("Machado")) {
                    atkBonus = 4;
                    addToLog(`ü™ì O machado lhe d√° +${atkBonus} de ataque.`);
                }
                
                let attackRoll = atkBonus + rollingDice(20)[0] + Math.floor((gameState.player.stats.str - 10)/2) + gameState.player.stats.bba;
                
                addToLog(`Voc√™ ataca o ${enemy.name} (AC ${enemy.ac})... Roll: ${attackRoll}`);
                
                if (attackRoll >= enemy.ac) {
                    const damage = rollingDice(8)[0] + Math.floor((gameState.player.stats.str - 10)/2);
                    addToLog(`ü•ä Voc√™ acerta ${damage} de dano no inimigo!`);

                    enemy.hp -= damage;
                    
                    if (enemy.hp <= 0) {
                        const xpGain = 50;
                        const goldGain = rollingDice(6, 3).reduce((a, b) => a + b);
                        addToLog(`üéä Voc√™ derrotou o ${enemy.name}! Ganhou ${xpGain} de XP e ${goldGain}g`);
                        gameState.player.xp += xpGain;
                        gameState.player.gold += goldGain;
                    } else {
                        addToLog(`ü•ä O ${enemy.name} sobreviveu e te ataca!`);
                        enemyAttack(enemy)
                    }
                } else {
                    addToLog("Voc√™ errou!");
                    addToLog(`ü•ä O ${enemy.name} te ataca!`);
                    enemyAttack(enemy)
                }
            }

            function enemyAttack(enemy) {
                let attackEnemy = rollingDice(20)[0] + Math.floor((gameState.player.stats.str - 10)/2) + gameState.player.stats.bba;
                let armorBonus = 0;
                if (gameState.player.inventory.includes("Escudo")) {
                    armorBonus = 4;
                    addToLog(`üõ°Ô∏è O escudo lhe d√° +${armorBonus} de armadura.`);
                }
                if (attackEnemy >= 10 + Math.floor((gameState.player.stats.dex - 10)/2) + gameState.player.stats.armor + armorBonus) {
                    addToLog(`ü•ä O ${enemy.name} acerta voc√™.`);
                    const enemyDamage = rollingDice(6)[0];
                    addToLog(`Voc√™ levou ${enemyDamage} de dano!`);
                    changeHealth(enemyDamage);
                } else {
                    addToLog(enemy.name + " miss!");
                }
            }

            function changeHealth(amount) {
                gameState.player.health += amount;
                if (gameState.player.health > gameState.player.maxHealth) gameState.player.health = gameState.player.maxHealth; // cap health
                if (gameState.player.health <= 0) {
                    gameState.player.health = 0;
                    addToLog("‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è Voc√™ morreu pq perdeu todos os pontos de vida! ‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è");
                    loadScene('death'); // Load death scene
                }
                updateStatsDisplay();
            }

            function changeGold(amount) {
                gameState.player.gold += amount;
                if (gameState.player.gold < 0) gameState.player.gold = 0; // No negative gold
                if (amount > 0) {
                    addToLog("Voc√™ ganhou " + amount + " ü™ô.");
                } else {
                    addToLog(amount + " ü™ô foi removido da sua mochila");
                }
                updateStatsDisplay();
            }

            function changeXP(amount) {
                gameState.player.xp += amount;
                updateStatsDisplay();
                addToLog("Voc√™ ganhou " + amount + " de XP." );
            }

            function addToInventory(item) {
                gameState.player.inventory.push(item);
                updateInventoryDisplay();
                addToLog(`Adicionado ${item} ao invent√°rio.`);
            }

            function removeFromInventory(item) {
                const index = gameState.player.inventory.indexOf(item);
                if (index > -1) {
                    gameState.player.inventory.splice(index, 1);
                    updateInventoryDisplay();
                    addToLog(`Removido ${item} ao invent√°rio.`);
                }
            }

            function haveMoney(amount) {
              if (amount < gameState.player.gold) {
                gameState.player.gold -= amount;
                addToLog(amount + " ü™ô foram removidas da sua mochila");
                updateStatsDisplay();
                return true;
              }

              return false;
            }

            function updateStatsDisplay() {
                document.getElementById('health').textContent = gameState.player.health;
                document.getElementById('gold').textContent = gameState.player.gold;
                document.getElementById('xp').textContent = gameState.player.xp;
            }

            function updateInventoryDisplay() {
                const inventoryItemsElement = document.getElementById('inventory-items');
                if (gameState.player.inventory.length === 0) {
                    inventoryItemsElement.textContent = "Mochila vazia!";
                } else {
                    inventoryItemsElement.innerHTML = ''; // Clear existing items
                    const ul = document.createElement('ul');
                    gameState.player.inventory.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        ul.appendChild(li);
                    });
                    inventoryItemsElement.appendChild(ul);
                }
            }

            function addToLog(message) {
                gameState.log.push(message);
                const logElement = document.getElementById('game-log');
                const logMessageElement = document.createElement('p');
                logMessageElement.textContent = message;
                logElement.appendChild(logMessageElement);
                logElement.scrollTop = logElement.scrollHeight; //Auto-scroll to bottom
            }

            // Selecionar elementos da lojinha
            const openShopButton = document.getElementById('open-shop');
            const closeShopButton = document.getElementById('close-shop');
            const shopModal = document.getElementById('shop-modal');
            const playerGoldElement = document.getElementById('player-gold');
            const shopItems = document.querySelectorAll('.shop-item');

            // Abrir a lojinha
            openShopButton.addEventListener('click', () => {
                playerGoldElement.textContent = `Ouro: ${gameState.player.gold}`;
                shopModal.classList.remove('hidden');
            });

            // Fechar a lojinha
            closeShopButton.addEventListener('click', () => {
                shopModal.classList.add('hidden');
            });

            // Comprar itens
            shopItems.forEach(item => {
                item.addEventListener('click', () => {
                    const itemName = item.getAttribute('data-item');
                    const itemPrice = parseInt(item.getAttribute('data-price'), 10);

                    if (gameState.player.gold >= itemPrice) {
                        gameState.player.gold -= itemPrice;
                        addToInventory(itemName);
                        playerGoldElement.textContent = `Ouro: ${gameState.player.gold}`;
                        addToLog(`Voc√™ comprou ${itemName} por ${itemPrice}g.`);
                        updateStatsDisplay(); // Atualiza o ouro na interface
                    } else {
                        addToLog("Ouro insuficiente para comprar este item.");
                    }
                });
            });

            function init() {
                // ... (configura√ß√£o inicial: scene, camera, etc. se aplic√°vel, ou elementos DOM)

                // Event Listeners para Teclado/Mouse/Toque (se houver, para o jogo em si)
                // document.addEventListener('keydown', handleKeyDown); // Exemplo se voc√™ tiver
                // gameContainer.addEventListener('click', handleGameClick); // Exemplo

                // --- Modificar listener de inicializa√ß√£o ---
                function initializeAudioAndSpeech() {
                     // Tenta inicializar/resumir AudioContext (se voc√™ usar √°udio para outras coisas)
                     /*
                     if (!audioContext) {
                         try {
                             audioContext = new (window.AudioContext || window.webkitAudioContext)();
                             console.log("Audio Context Created on user gesture.");
                         } catch (e) { console.error("Error creating Audio Context:", e); }
                     }
                     if (audioContext && audioContext.state === 'suspended') {
                         audioContext.resume().catch(e => console.error("Error resuming AudioContext:", e));
                     }
                     */

                    // --- Inicializa√ß√£o da API de Fala ---
                    if (synth) { // Verifica se a API existe no navegador
                        if (!speechApiUnlocked) {
                             // Tenta "desbloquear" a API com uma chamada silenciosa ou resume
                             // synth.speak(new SpeechSynthesisUtterance('')); // M√©todo comum, mas pode dar 'cancelled'
                            // Ou tenta retomar, pode ser suficiente em alguns navegadores
                             if (synth.paused) { synth.resume(); } // Se estiver pausado, retoma
                             if (synth.speaking) { synth.cancel(); } // Cancela algo que possa ter ficado preso

                            console.log("Tentativa de desbloquear Speech Synthesis API.");
                            speechApiUnlocked = true; // Assume que foi desbloqueado pela intera√ß√£o

                             // Popula a lista de vozes. A lista pode n√£o estar pronta imediatamente.
                             // Op√ß√£o 1: Tenta popular direto (pode n√£o ter vozes ainda)
                             populateVoiceList();
                             // Op√ß√£o 2: Tenta popular ap√≥s um pequeno atraso
                              // setTimeout(populateVoiceList, 250);
                             // Op√ß√£o 3 (Melhor): Usa o evento 'onvoiceschanged'
                             if (synth.onvoiceschanged !== undefined) {
                                 synth.onvoiceschanged = populateVoiceList;
                            }
                        }
                    } else {
                        console.warn("Web Speech API (speechSynthesis) n√£o suportada neste navegador.");
                        ttsEnabled = false; // Desabilita TTS se n√£o for suportado
                    }
                    // --- Fim Inicializa√ß√£o da Fala ---


                    // Atualiza UI e remove listeners
                    window.removeEventListener('click', initializeAudioAndSpeech);
                    window.removeEventListener('keydown', initializeAudioAndSpeech);
                    window.removeEventListener('touchstart', initializeAudioAndSpeech); // Adicionar touch
                 }

                // Adiciona listeners para a primeira intera√ß√£o
                window.addEventListener('click', initializeAudioAndSpeech, { once: true });
                window.addEventListener('keydown', initializeAudioAndSpeech, { once: true });
                window.addEventListener('touchstart', initializeAudioAndSpeech, { once: true }); // Adicionar touch

                // --- In√≠cio do Jogo ---
                // N√£o chame loadScene aqui, espere a sele√ß√£o de personagem
                // initGame(); // Ou qualquer fun√ß√£o que prepare a tela inicial
                updateStatsDisplay(); // Atualiza a UI inicial
                updateInventoryDisplay(); // Atualiza UI inicial

                // --- Controle Opcional de Mudo TTS ---
                const ttsToggleButton = document.getElementById('tts-toggle-button');

                function updateTtsButtonVisual() {
                     if (ttsToggleButton) {
                         ttsToggleButton.textContent = ttsEnabled ? 'üîä Narrador' : 'üîá Narrador';
                         ttsToggleButton.style.opacity = ttsEnabled ? '1' : '0.6';
                     }
                 }

                if (ttsToggleButton) {
                    ttsToggleButton.addEventListener('click', () => {
                        ttsEnabled = !ttsEnabled;
                        updateTtsButtonVisual();
                        if (!ttsEnabled) {
                            stopSpeech(); // Para a fala imediatamente se for desabilitado
                        }
                        console.log("TTS Habilitado:", ttsEnabled);
                    });
                    updateTtsButtonVisual(); // Define o estado inicial do bot√£o
                }
                // --- Fim Controle Opcional ---
            }

            // Chame init() no final do script para configurar tudo
            init();

        </script>
    </body>
</html>